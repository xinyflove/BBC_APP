<!-- <{*update 王衍生 20170924*}> -->
<style>
  header .header-left {
      color: #c0c0c0;
  }

  .shopex-input-group{
    background-color: #efeff4;
    width:90%;
    margin: 0 auto;
  }

  .shopex-input-row{
    border-bottom: 0px;
  }

  .shopex-input-row label {
    display: block;
    width: 4.0rem;
    padding: 0rem;
    font-family: "Helvetica Neue", Helvetica, sans-serif;
    padding-top: 0.8rem;
  }

  .form-container .form-inline .form-inline-unadaptive {
      width: 30%;
      padding-right: 0rem;
  }

  .send_vcode{
    height: 100%;
    line-height: 50px;
    color: #333333;
    font-size: 12px;
    padding-left: 1.0rem;
  }

  .bbc-btn-warning {
      background: #ff9d0c;
      border-color: #ff9d0c;
      margin: 0;
  }
</style>
<div class="body-padding">
  <header class="page-header">
    <i class="header-left icon-func bbc-icon bbc-icon-back shopex-action-back"></i>
    <div class="header-title bind_title">绑定已有账号</div>
  </header>
  <section class="container">
    <form id="bind_acount_form" class="form-container" action="<{url action=topwap_ctl_trustlogin@bindExistsUser}>" method="post">
      <input type="hidden" name="vcodekey" value="topwap_signin">
      <input type="hidden" name="flag" value="<{$flag}>">
      <input type="hidden" name="type" value="activation">
      <div class="content-padded content-center">
        <div class="trust-login-avatar"><img src="<{$avatar|storager}>" alt=""></div>
        <div>Hi~
          <{$realname}>，绑定已有账号</div>
      </div>
      <section class="shopex-input-group">
        <div class="shopex-input-row">
          <label>账号：</label>
          <input type="text" class="shopex-input-clear" name="uname" placeholder="请输入手机号" required data-caution="请输入手机号">
        </div>
        <div class="shopex-input-row" style="display: none;">
          <label>密码：</label>
          <input type="password" class="shopex-input-password" name="password" placeholder="请输入密码" required data-caution="请输入密码">
        </div>
        <div class="form-inline" id="bind_vdode" style="display: none;">
          <div class="shopex-input-row form-inline-adaptive">
            <label>验证码：</label>
            <input type="text" name="verifycode" class="" placeholder="请输入验证码" required data-caution="请输入验证码">
          </div>
          <div class="form-inline-unadaptive">
            <img align="absmiddle" class="auto-change-verify-handle" src="<{url action=toputil_ctl_vcode@gen_vcode key=topwap_signin width=120 height=35}>" alt="" width="100" height="30">
          </div>
        </div>

        <!-- add start 王衍生 20170923 -->
        <div class="form-inline">
          <div class="shopex-input-row form-inline-adaptive">
            <label>验证码：</label>
            <input type="text" name="vcode" class="shopex-input-clear" placeholder="请输入短信验证码">
          </div>
          <div class="form-inline-unadaptive">
            <!-- <button type="button" id="" class="shopex-btn shopex-btn-warning shopex-btn-block btn-action send_vcode">发送验证码</button> -->
            <p class="send_vcode">发送验证码</p>
          </div>
        </div>
        <!-- add end 王衍生 20170923 -->

      </section>
      <section class="content-horizontal-padded form-op-section">
        <button type="button" class="shopex-btn shopex-btn-block shopex-btn-warning bbc-btn-warning" id="bind_acount_submit">完成</button>
      </section>
    </form>
    <form id="new_acount_form" class="form-container" action="<{url action=topwap_ctl_trustlogin@bindSignupUser}>" style="display: none;" method="post">
      <input type="hidden" name="vcodekey" value="topwap_signin">
      <input type="hidden" name="flag" value="<{$flag}>">
      <input type="hidden" name="type" value="signup">
      <div class="content-padded content-center">
        <div class="trust-login-avatar"><img src="<{$avatar|storager}>" alt=""></div>
        <div>Hi~
          <{$realname}>，您可以注册新账号</div>
      </div>
      <section class="shopex-input-group">
        <{if $env.conf.sysconf.user.account.register.multipletype}>
        <div class="shopex-input-row">
          <label>帐号：</label>
          <input type="text" class="shopex-input-clear" name="pam_account[login_name]" placeholder="请输入用户名或手机号" required data-caution="请输入用户名或手机号">
        </div>
        <{else}>
        <div class="shopex-input-row">
          <label>手机号：</label>
          <input type="text" class="shopex-input-clear" name="pam_account[login_name]" placeholder="请输入手机号" maxlength="11" minlenght="11" required data-caution="请输入手机号">
        </div>
        <{/if}>
        <div class="shopex-input-row" style="display: none;">
          <label>设置密码：</label>
          <input type="password" class="shopex-input-password" name="pam_account[login_password]" placeholder="请输入新密码，6~20位" required minlength="6" maxlength="20" data-caution="请填写密码，6-20个字符&&输入不正确，最少6个字符&&输入不正确，最多20个字符">
        </div>
        <div class="shopex-input-row" style="display: none;">
          <label>确认密码：</label>
          <input type="password" class="shopex-input-password" name="pam_account[psw_confirm]" maxlength="20" placeholder="再次填写密码" required data-equalto="pam_account[login_password]" data-caution="密码与确认密码不相符，请重新填写">
        </div>
        <div class="form-inline" style="display: none;">
          <div class="shopex-input-row form-inline-adaptive">
            <label>验证码：</label>
            <input type="text" name="verifycode" class="" placeholder="请输入验证码" required data-caution="请输入验证码">
          </div>
          <div class="form-inline-unadaptive">
            <img align="absmiddle" class="auto-change-verify-handle" src="<{url action=toputil_ctl_vcode@gen_vcode key=topwap_signin width=120 height=35}>" alt="" width="100" height="30">
          </div>
        </div>
        <!-- add start 王衍生 20170923 -->
        <div class="form-inline">
          <div class="shopex-input-row form-inline-adaptive">
            <label>验证码：</label>
            <input type="text" name="vcode" class="shopex-input-clear" placeholder="请输入短信验证码">
          </div>
          <div class="form-inline-unadaptive">
            <!-- <button type="button" id="" class="shopex-btn shopex-btn-warning shopex-btn-block btn-action send_vcode">发送验证码</button> -->
            <p class="send_vcode">发送验证码</p>
          </div>
        </div>
        <!-- add end 王衍生 20170923 -->
      </section>
      <section class="content-horizontal-padded form-op-section">
        <button type="button" class="shopex-btn shopex-btn-block shopex-btn-warning bbc-btn-warning" id="new_acount_button">完成</button>
      </section>
    </form>
    <section class="action-bar content-horizontal-padded" style="position:static;background:none">
      <button id="new_acount" type="button" class="shopex-btn shopex-btn-block box-item-flex1" onclick="return false;">成为新用户</button>
      <button id="bind_acount" style="display: none" type="button" class="shopex-btn shopex-btn-block box-item-flex1" onclick="return false;">绑定已有账号</button>
    </section>
  </section>
</div>
<script>
$('#bind_acount').on('tap', function() {
  $('#new_acount_form').hide();
  $('#bind_acount_form').show();
  $(this).hide();
  $('#new_acount').show();
  $('.bind_title').text('绑定已有账号');
})
$('#new_acount').on('tap', function() {
  $('#new_acount_form').show();
  $('#bind_acount_form').hide();
  $(this).hide();
  $('#bind_acount').show();
  $('.bind_title').text('成为新用户');
})
// 绑定老用户
var form = $('#bind_acount_form');
$('#bind_acount_submit').on('tap', function() {
    var _this = this;
    if($(_this).attr("is_disabled") == '1'){
        return;
    }
    $(_this).attr("is_disabled", '1');
  $.post(form.attr('action'), form.serialize(), function(rs) {
    if (rs.error && rs.redirect == 'vcode_is_show') {
      changeCode($('.auto-change-verify-handle'));
    }

    if (rs.error) {
      shopex.alert(rs.message);
    }

    if (rs.redirect) {
      if (rs.redirect == 'vcode_is_show') {
        $('#bind_vdode').show();
        return false;
      } else {
        location.href = rs.redirect;
      }
    }
    $(_this).attr("is_disabled", '0');

  })
});

// 注册新用户
var newform = $('#new_acount_form');
$('#new_acount_button').on('tap',function(){
    var _this = this;
    if($(_this).attr("is_disabled") == '1'){
        return;
    }
    $(_this).attr("is_disabled", '1');

  $.post(newform.attr('action'), newform.serialize(), function(rs) {
    if (rs.error) {
      shopex.alert(rs.message);
      changeCode($('.auto-change-verify-handle'));
    }

    if (rs.redirect) {
        location.href = rs.redirect;
    }
    $(_this).attr("is_disabled", '0');
  })
});
// add start 王衍生 20170923
$('.send_vcode').on('click', function(e) {
  var current_form = $(this).parents("form");
  if(current_form.attr('id') == 'new_acount_form'){
    var uname = current_form.find("input[name='pam_account[login_name]']").val();
  }else{
    var uname = current_form.find('input[name=uname]').val();
  }
  var type = current_form.find('input[name=type]').val();
  if($(this).hasClass('disabled')) return false;
  sendVerify(this, 'uname='+uname+'&type=' +type);
});
// 发送验证码
function sendVerify(el, data) {
  var url = "<{url action=topwap_ctl_trustlogin@sendVcode}>";
  var textCont = $(el);
  $(el).addClass('disabled');
  textCont.html('<i>0</i>');
  var cd = new countdown(textCont.find('i'), {
    start: 120,
    secondOnly: true,
    callback: function(e) {
      $(el).removeClass('disabled');
      textCont.html('重发验证码');
    }
  });
  $.post(url, data, function(rs) {
    if(rs.error) {
      cd.stop();
      alert(rs.message);
      $(el).removeClass('disabled');
      textCont.html('重发验证码');
    }
  });
}

function pushHistory() {
    var state = {
        title: "title",
        url: "#"
    };
    if(state.url){
      window.history.pushState(state, "title", "#");
    }
}

$(function() {

      pushHistory();
      var bool=false;
      setTimeout(function(){
            bool=true;
      },1500);
      window.addEventListener("popstate", function(e) {
        if(bool)
          {
            // alert("我监听到了浏览器的返回按钮事件啦");//根据自己的需求实现自己的功能
            location.href = "<{$back_url}>";
          }
          pushHistory();

      }, false);
});
// add end 王衍生 20170923
</script>
