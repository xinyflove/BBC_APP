<!--表单开始-->
<form class="form-horizontal" action="<{url action=topshop_ctl_mall_admin_item@save}>" method="post" role="form" id="specification" data-validate-onsuccess="ajaxSubmit" data-validate-excluded=":disabled, :not(:visible)">
    <{*<input type="hidden" name="rsftockens" value="<{$rsf|gettocken}>">*}>
    <input type="hidden" name="item[item_id]" value="<{$item.item_id}>">
    <input type="hidden" name="return_to_url" value="<{$return_to_url}>">
	<!--面板开始-->
    <div class="panel panel-outter">
        <!--面板头部开始-->
        <div class="panel-heading">
            <h4>产品信息</h4>
            <!--产品分类信息开始-->
            <div>
                <span class="act-handle pull-left text-light-blue">
                    <span></span>
                </span>
                <button type="button" data-toggle="modal" data-target="#catDialog" class="btn btn-default btn-sm" disabled="disabled">
                    选择平台分类
                </button>
                <label data-toggle="tooltip" data-placement="top" title="每个商品必须选择一个平台的叶子节点分类(选到最后一个分类)">
                    <i class="fa fa-question-circle text-aqua"></i>
                </label>
                <span class="brandErr"></span>
                <!--选择平台分类弹框开始-->
                <div id="catDialog" class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                                <h4 class="modal-title">选择平台分类</h4>
                            </div>
                            <div class="modal-body">
                                <{input type="category" name="item[cat_id]" shop_id=$shopId value=$item.cat_id callback="categoryCallback"}>
                                <input type="hidden" name="item[sku]">
                                <input type="hidden" name="item[spec]">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" <{if !$item.item_id}>disabled<{/if}>>保存</button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--选择平台分类弹框结束-->
            </div>
            <!--产品分类信息结束-->
        </div>
        <!--面板头部结束-->

        <!--面板body开始-->
        <div class="panel-body hide">
            <!--商品信息开始-->
            <div class="col-md-11">
                <{if $item.approve_status != "pending"}><h4>编辑商品</h4><{else}><h4>查看商品</h4><{/if}>
                <!--基本内容开始-->
                <div id="floor_1" class="panel panel-default">
                    <div class="panel-heading">基本内容</div>

                    <div class="panel-body">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                <span class="txt-required">*</span> 商品标题：
                            </label>
                            <div class="col-sm-3">
                                <input type="text" name="item[title]" value="<{$item.title}>" required class="form-control" maxlength="50" disabled="disabled">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                副标题：
                            </label>
                            <div class="col-sm-3">
                                <textarea name="item[sub_title]" class="form-control" maxlength="150" rows="4" disabled="disabled"><{$item.sub_title}></textarea>
                            </div>
                            <span class="label label-info">标题广告语</span>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                <span class="txt-required">*</span>
                                是否为平台供货：
                            </label>
                            <div class="col-sm-3">
                                <{if $accounting_type=='thirdparty'}>
                                <select name="item[is_clearing]" required class="form-control" >
                                    <option value='0' selected>否</option>
                                </select>
                                <{else}>
                                <select name="item[is_clearing]" required class="form-control" <{if $item.is_clearing ===1 || $item.is_clearing === 0}>disabled<{/if}>>
                                    <option value="" ><{t}>请选择<{/t}></option>
                                    <option value='1' <{if $item.is_clearing===1}>selected<{/if}>>是</option>
                                    <option value='0' <{if $item.is_clearing===0}>selected<{/if}>>否</option>
                                </select>
                                <{/if}>
                            </div>
                            <span class="label label-danger">保存后不能修改，请谨慎填写，如有疑问，请联系电商公司确认，以免导致结算有误</span>
                        </div>

                        <!--add_20171013_by_wudi_start-->
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"></label>
                            <div class="col-sm-10">
                                <span class="help-block">
                                    如为店铺自营产品，请为店铺创建供应商账号，供应商名称形式为“店铺名称（自营）”，公司名称请按照实际情况填写
                                </span>
                            </div>
                        </div>
                        <!--add_20171013_by_wudi_end-->

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                <span class="txt-required">*</span> 选择供应商：
                            </label>
                            <div class="col-sm-3">
                                <button type="button" data-toggle="modal" data-target="#supplierDialog" class="btn btn-default btn-sm btn-brand" disabled="disabled">供应商</button>&nbsp;&nbsp;<span class="supplier-choose-txt" data-id=""><{$item.supplier_name}></span>
                                <{include file="topshop/item/supplier.html"}>
                                <input type="hidden" name="item[supplier_id]" value="<{$item.supplier_id}>" />
                            </div>
                        </div>

                        <!--add_20170924_by_wudi_start-->
                        <hr>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">虚拟卡卷部分:</label>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否为虚拟商品：</label>
                            <div class="col-sm-10">
                                <{if $item.is_virtual===1 || $item.is_virtual===0}>
                                <input class="is_virtual" type="radio" name="item[is_virtual]" value="1" <{if $item.is_virtual == 1}>checked<{/if}> disabled> 是
                                <input class="is_virtual" type="radio" name="item[is_virtual]" value="0" <{if $item.is_virtual != 1}>checked<{/if}> disabled> 否
                                <input type="hidden" name="item[is_virtual]" value="<{$item.is_virtual}>">
                                <{else}>
                                <input class="is_virtual" type="radio" name="item[is_virtual]" value="1" <{if $item.is_virtual == 1}>checked<{/if}>> 是
                                <input class="is_virtual" type="radio" name="item[is_virtual]" value="0" <{if $item.is_virtual != 1}>checked<{/if}>> 否
                                <{/if}>
                                <span class="label label-danger">保存后不能修改，请谨慎填写，如有疑问，请联系电商公司确认，以免导致结算有误</span>
                            </div>
                        </div>

                        <{if $item.is_virtual===1 || $item.is_virtual===0}>
                        <{assign var="is_virtual" value=1}>
                        <{/if}>
                        <{if $offline=='on'}>
                        <!--支付核销参数开始-->
                        <div class="form-group confirm_type" style="<{if $is_virtual==1}><{else}>display:none<{/if}>">
                            <label for="" class="col-sm-2 control-label">虚拟商品核销方式：</label>
                            <div class="col-sm-10">
                                <input class="confirm_type-input" type="radio" name="item[confirm_type]" value="0" <{if $item.confirm_type == 0}>checked="checked"<{/if}><{if isset($item.confirm_type)}>disabled<{/if}>> 扫码核销
                                <input class="confirm_type-input" type="radio" name="item[confirm_type]" value="1" <{if $item.confirm_type == 1}>checked="checked"<{/if}><{if isset($item.confirm_type)}>disabled<{/if}>> 支付核销
                            </div>
                        </div>
                        <div class="form-group agent_price" <{if $is_virtual==1 && $item.confirm_type == 1}>disabled<{else}> style="display:none" <{/if}>>
                            <label for="" class="col-sm-2 control-label">有偿劵/无偿劵：</label>
                            <div class="col-sm-10">
                                <input class="agent_price_input" type="radio" name="item[agent_price]" value="0" <{if $item.agent_price == 0}>checked="checked"<{/if}><{if isset($item.agent_price)}>disabled<{/if}>> 无偿劵
                                <input class="agent_price_input" type="radio" name="item[agent_price]" value="1" <{if $item.agent_price == 1}>checked="checked"<{/if}><{if isset($item.agent_price)}>disabled<{/if}>> 有偿劵
                            </div>
                        </div>

                        <div class="form-group agent_type"  <{if $is_virtual==1 && $item.confirm_type == 1}><{else}> style="display:none"<{/if}>>
                            <label for="" class="col-sm-2 control-label">劵类别：</label>
                            <div class="col-sm-10">
                                <select class="agent_type_select" name="item[agent_type]" <{if $is_virtual==1 && $item.confirm_type == 1}>disabled<{/if}>>
                                    <option value="">...</option>
                                    <option value="CASH_VOCHER" <{if $item.agent_type == 'CASH_VOCHER'}>selected<{/if}>>代金劵</option>
                                    <option value="DISCOUNT" <{if $item.agent_type == 'DISCOUNT'}>selected<{/if}>>满折</option>
                                    <option value="REDUCE" <{if $item.agent_type == 'REDUCE'}>selected<{/if}>>满减</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group deduct_price" <{if $is_virtual==1 && $item.confirm_type == 1 && ($item.agent_type == 'REDUCE' || $item.agent_type == 'DISCOUNT' || $item.agent_type == 'CASH_VOCHER')}><{else}> style="display:none" <{/if}>>
                            <label class="col-sm-2 control-label">优惠的金额或者折扣的数值：</label>
                            <div class="col-sm-10">
                                <input class="deduct_price_input" type="text" name="item[deduct_price]" value="<{$item.deduct_price}>" placeholder="" <{if $is_virtual==1 && $item.confirm_type == 1 && ($item.agent_type == 'REDUCE' || $item.agent_type == 'DISCOUNT')}>disabled<{/if}> disabled="disabled">
                                <span class="danger-block deduct_price_span"></span>
                            </div>
                        </div>

                        <div class="form-group agent_use_limit" <{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'CASH_VOCHER'}><{else}> style="display:none" <{/if}>>
                            <label class="col-sm-2 control-label">使用数量限制：</label>
                            <div class="col-sm-10">
                                <input class="agent_use_limit_input" type="number" name="item[agent_use_limit]" value="<{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'CASH_VOCHER'}><{$item.agent_use_limit}><{else}>0<{/if}>" placeholder="使用数量限制" <{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'CASH_VOCHER'}>disabled<{/if}> disabled="disabled">
                                <span class="danger-block agent_use_limit_span"></span>
                            </div>
                        </div>

                        <div class="form-group max_deduct_price" <{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'DISCOUNT'}><{else}> style="display:none" <{/if}>>
                            <label for="" class="col-sm-2 control-label"> 卡券最大抵扣金额：</label>
                            <div class="col-sm-10">
                                <input class="max_deduct_price_input" type="text" name="item[max_deduct_price]" value="<{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'DISCOUNT'}><{$item.max_deduct_price}><{else}>0<{/if}>" placeholder="卡券最大抵扣金额" <{if $is_virtual==1 && $item.confirm_type == 1 && $item.agent_type == 'DISCOUNT'}>disabled<{/if}> disabled="disabled">
                                <span class="danger-block max_deduct_price_span"></span>
                            </div>
                        </div>

                        <div class="form-group min_consum" <{if $is_virtual==1 && $item.confirm_type == 1 && ($item.agent_type == 'REDUCE' || $item.agent_type == 'DISCOUNT' || $item.agent_type == 'CASH_VOCHER')}><{else}> style="display:none" <{/if}>>
                            <label for="" class="col-sm-2 control-label"> 卡券的最低消费金额限制：</label>
                            <div class="col-sm-10">
                                <input class="min_consum_inp" type="text" name="item[min_consum]" value="<{if $is_virtual==1 && $item.confirm_type == 1 && ($item.agent_type == 'REDUCE' || $item.agent_type == 'DISCOUNT' || $item.agent_type == 'CASH_VOCHER')}><{$item.min_consum}><{else}>1<{/if}>" placeholder="卡券的最低消费金额限制" <{if $is_virtual==1 && $item.confirm_type == 1 && ($item.agent_type == 'REDUCE' || $item.agent_type == 'DISCOUNT' || $item.agent_type == 'CASH_VOCHER')}>disabled<{/if}> disabled="disabled">
                                <span class="danger-block min_consum_span"></span>
                            </div>
                        </div>

                        <div class="form-group agentShopDialog" <{if $is_virtual==1 && $item.confirm_type == 1}><{else}>style="display:none"<{/if}>>
                            <label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 选择线下店：</label>
                            <div class="col-sm-3">
                                <button type="button" data-toggle="modal" data-target="#agentShopDialog" class="btn btn-default btn-sm btn-brand" disabled="disabled">线下店</button>&nbsp;&nbsp;<span class="agent-shop-choose-txt" data-id=""><{$item.agent_shop_names}></span>
                                <{include file="topshop/item/agentShop.html"}>
                                <input type="hidden" name="item[agent_shop_id]" value="<{$item.agent_shop_id}>" />
                            </div>
                        </div>
                        <hr>
                        <!--支付核销参数结束-->
                        <{/if}>

						<!--add_2018/10/9_by_wanghaichao_start-->
						<div class="form-group virtual" <{if $item['is_virtual']!=1}>style="display:none"<{/if}>>
							<label for="" class="col-sm-2 control-label">虚拟商品类型：</label>
							<div class="col-sm-10">
								<label style="font-weight:normal"><input class="is_ticket" type="radio" name="item[is_ticket]" value="0" <{if $item.is_ticket != 1}>checked<{/if}><{if $item}> disabled<{/if}>>单品</label>
								<label style="font-weight:normal"><input class="is_ticket" type="radio" name="item[is_ticket]" value="1" <{if $item.is_ticket == 1}>checked<{/if}><{if $item}> disabled<{/if}>>多品</label>
								<{if $item}>
								<input type="hidden" name="item[is_ticket]" value="<{$item.is_ticket}>">
								<{/if}>
							</div>
						</div>
						<div class="ticketshow" <{if $item['is_ticket']==1 && $item['is_virtual']==1}>style="display:block"<{else}>style="display:none"<{/if}>>
							<div class="ticket">
								<{if $ticket}>
									<{foreach from=$ticket item=tick key=key}>
									<div class="form-group">
										<label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 标题：</label>
										<div class="col-sm-3">
											<input type="text" name="ticket[<{$key}>][title]" value="<{$tick.title}>" required class="form-control" maxlength="50" disabled="disabled">
										</div>
										<div class="col-sm-5">
											<a href="<{url action=topshop_ctl_item@modeSupplier supplier_id=$tick.supplier_id key=$key response=html}>" data-toggle="modal" data-target="#modeSupplier" class="btn btn-default btn-sm btn-brand" disabled="disabled">选择供应商</a>&nbsp;&nbsp;<span class="supplier-choose-txt-<{$key}>" data-id=""><{$tick.supplier_name}></span>
											<input type="hidden" name="ticket[<{$key}>][supplier_id]" value="<{$tick.supplier_id}>" />
											<input type="hidden" name="ticket[<{$key}>][id]" value=<{$tick.id}>>
										</div>
										
										<!--<div class="col-sm-2">
											<a class="btn btn-danger btn-sm btn-brand" onclick="removeItem(this)">删除</a>
										</div>-->
									</div>
									<{/foreach}>
								<{else}>
								<div class="form-group">
									<label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 标题：</label>
									<div class="col-sm-3">
										<input type="text" name="ticket[0][title]" value="" required class="form-control" maxlength="50">
									</div>
									<div class="col-sm-5">
										<a href="<{url action=topshop_ctl_item@modeSupplier key=0 response=html}>" data-toggle="modal" data-target="#modeSupplier" class="btn btn-default btn-sm btn-brand">选择供应商</a>&nbsp;&nbsp;<span class="supplier-choose-txt-0" data-id=""><{$tick.supplier_name}></span>
										<input type="hidden" name="ticket[0][supplier_id]" value="" />
									</div>
									<div class="col-sm-2">
										<a class="btn btn-danger btn-sm btn-brand" onclick="removeItem(this)">删除</a>
									</div>
								</div>
								<{/if}>
							</div>
							<!--<div class="form-group ">
								<div class="col-sm-2"></div>
								<div class="col-sm-3"><button type="button" class="btn btn-default btn-sm btn-brand" data-id='<{$count}>' onclick="addItem(this)">添加一个</button></div>
							</div>-->
						</div>
					<!--add_2018/10/9_by_wanghaichao_end-->

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否为跨境商品：</label>
                            <div class="col-sm-10">
                                <input class="is_cross" type="radio" name="item[is_cross]" value="1" <{if $item.is_cross == 1}>checked<{/if}> disabled="disabled"> 是
                                <input class="is_cross" type="radio" name="item[is_cross]" value="0" <{if $item.is_cross != 1}>checked<{/if}> disabled="disabled"> 否
                            </div>
                        </div>

                        <!--add_20170924_by_wudi_start-->
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 品牌：</label>
                            <div class="col-sm-3">
                                <button type="button" data-toggle="modal" data-target="#brandDialog" class="btn btn-default btn-sm btn-brand" disabled="disabled">选择品牌</button>&nbsp;&nbsp;
                                <span class="brand-choose-txt" data-id=""></span>
                                <{include file="topshop/item/brand.html"}>
                                <input type="hidden" name="item[brand_id]" value="" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">商品图片：</label>
                            <div class="col-sm-10">
                                <div class="multiple-upload pro-thumb" >
                                    <{if $item.images}>
                                    <{foreach from=$item.images item=image_id key=key }>
                                    <div class="multiple-item">
                                        <div class="multiple-del glyphicon glyphicon-remove-circle" style="display: none;"></div>
                                        <a class="select-image" href="javascript:;" style="cursor: default;">
                                            <input type="hidden" name="listimages[]" value="<{$image_id}>">
                                            <div class="img-put"><img src="<{$image_id|storager:t}>"></div>
                                        </a>
                                    </div>
                                    <{/foreach}>
                                    <{/if}>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"></label>
                            <div class="col-sm-10"><span class="help-block">本类目您最多可上传10张图片，拖拽可排序。</span></div>
                        </div>

                        <!--add_2017/10/30_by_gurundong_start 直播热售图-->
                        <div class="form-group">
                            <label class="col-sm-2 control-label"><{t}>直播热售图<{/t}>：</label>
                            <div class="col-sm-5">
                                <div class="multiple-item" style="position:relative">
                                    <a class="select-image" href="javascript:;" style="cursor: default;">
                                        <input class="reshow_logo" type="hidden" name="item[livehot_img]" value="<{$item.livehot_img}>">
                                        <div class="img-put">
                                            <img  class="rightlogo"  src="<{$item.livehot_img}>">
                                            <i class="glyphicon glyphicon-picture"></i>
                                        </div>
                                    </a>
                                </div>
                                <span class="help-block">直播热售图尺寸标准：320*175px。</span>
                            </div>
                        </div>
                        <!--add_2017/10/30_by_gurundong_end-->

                        <!--add_2017/9/23_by_wanghaichao_start 商品图小图标-->
                        <div class="form-group">
                            <label class="col-sm-2 control-label"><{t}>右上角角标<{/t}>：</label>
                            <div class="col-sm-5">
                                <div class="multiple-item" style="position:relative">
                                    <a class="select-image" href="javascript:;" style="cursor: default;">
                                        <input class="right_logo" type="hidden" name="item[right_logo]" value="<{$item.right_logo}>">
                                        <div class="img-put">
                                            <img  class="rightlogo"  src="<{$item.right_logo}>">
                                            <i class="glyphicon glyphicon-picture"></i>
                                        </div>
                                    </a>
                                </div>
                                <span class="help-block">角标尺寸标准：60*60 px。</span>
                            </div>
                        </div>
                        <!--add_2017/9/23_by_wanghaichao_end-->

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">发布平台：</label>
                            <div class="col-sm-10 radio" >
                                <label  class="form-inline">
                                    <input type="radio" name="item[use_platform]" value="0" disabled="disabled" <{if !$item.use_platform}>checked<{/if}> > 电脑端和移动端
                                </label>
                                <label  class="form-inline">
                                    <input type="radio" name="item[use_platform]" value="1" disabled="disabled" <{if $item.use_platform == 1}>checked<{/if}>> 电脑端
                                </label>
                                <label  class="form-inline">
                                    <input type="radio" name="item[use_platform]" value="2" disabled="disabled" <{if $item.use_platform == 2}>checked<{/if}>> 移动端
                                </label>
                            </div>
                        </div>

                        <!-- start add 王衍生 20170925 -->
                        <!-- <{script src="jquery.ui.widget.js" app="topshop"}> -->
                        <!-- <{script src="jquery.iframe-transport.js" app="topshop"}> -->
                        <!-- <{script src="jquery.fileupload.js" app="topshop"}> -->

                        <div class="form-group">
                            <label class="col-sm-2 control-label">商品视频</label>
                            <div class="col-sm-10">
                                <div class="row item_video">
                                <{if $item.video_dir}>
                                <{foreach from=$item.video_dir item=data}>
                                        <div class="col-sm-3 item">
                                            <div class="removeVideo glyphicon glyphicon-remove-circle" style="position: absolute;left: 207px;top: 4px;z-index: 999;"></div>
                                            <div class="thumbnail">
                                                <div class="img-show">
                                                    <video src="<{$data.url|storager}>" controls="controls" preload style="width: 100%;height: 150px;">
                                                        您的浏览器不支持 video 标签。
                                                    </video>
                                                </div>
                                                <div class="caption">
                                                <span class="video-name"><{$data.video_name}></span>
                                                </div>
                                            </div>
                                            <input type="hidden" name="item[video_dir][]" value="<{$data.url}>" class="form-control">
                                        </div>
                                <{/foreach}>
                                <{/if}>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#video_modal" data-remote="<{url action=topshop_ctl_shop_video@loadVideoModal}>" data-callback="item_select_video_callback" data-limit="1" disabled="disabled">选择视频</button>
                                        <span class="help-block">请上传MP4,OGG格式，最大20M的视频。</span>
                                        <span class="help-block">目前一个商品只支持上传一个视频。</span>
                                    </div>
                                </div>
                            </div>
                        </div>
<script>
    // 添加视频回调函数
    function item_select_video_callback(videos){
        var html = '';
        $.each(videos, function (index, file) {
            html += '<div class="col-sm-3 item">\
                    <div class="removeVideo glyphicon glyphicon-remove-circle" style="position: absolute;left: 207px;top: 4px;z-index: 999;"></div>\
                    <div class="thumbnail">\
                        <div class="img-show">\
                            <video src="'+ file.video_url + '" controls="controls" preload style="width: 100%;height: 150px;">\
                                您的浏览器不支持 video 标签。\
                            </video>\
                        </div>\
                        <div class="caption">\
                        <span class="video-name">'+ file.video_name + '</span>\
                        </div>\
                    </div>\
                    <input type="hidden" name="item[video_dir][]" value="'+ file.video_id + '" class="form-control">\
                </div>';
        });
        $('.item_video').html(html);
    }
    // 删除视频
    $('.item_video').on('click', '.removeVideo', function(){
        $(this).parent().remove();
    })
</script>
                        <!-- end add 王衍生 20170925 -->

                        <!---start whc_是否是银行卡特卖商品2017/9/7---->
                        <{if $banks}>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否为银行卡商品：</label>
                            <div class="col-sm-10">
                                <label  class="form-inline">
                                    <input class="is_bank" type="radio" name="is_bank" value="1" <{if $item.is_bank == 1}>checked<{/if}>> 是
                                </label>
                                <label  class="form-inline">
                                    <input class="is_bank" type="radio" name="is_bank" value="0" <{if $item.is_bank != 1}>checked<{/if}>> 否
                                </label>
                            </div>
                        </div>

                        <div class="form-group banks"  <{if $item['is_bank']!=1}> style="display:none"<{/if}>>
                            <label for="" class="col-sm-2 control-label">选择银行卡：</label>
                            <div class="col-sm-10">
                                <{if $banks}>
                                <{foreach from=$banks item=bank}>
                                <label>
                                    <input type="checkbox" required name="bank_id[]" <{if in_array($bank.bank_id,$item.bank_ids)}> checked<{/if}> value="<{$bank.bank_id}>"><{$bank.bank_name}>
                                </label>
                                <{/foreach}>
                                <{else}>
                                暂无绑定银行
                                <{/if}>
                            </div>
                        </div>

                        <!--add_2017/12/11_by_wanghaichao_start-->
                        <!------是否仅限银行卡用户够买------->
                        <div class="form-group banks" <{if $item['is_bank']!=1}> style="display:none"<{/if}>>
                            <label for="" class="col-sm-2 control-label">是否仅限银行卡用户购买</label>
                            <div class="col-sm-10">
                                <label  class="form-inline">
                                    <input class="only_bank" type="radio" name="item[only_bank]" value="1" <{if !$item || $item.only_bank == 1}>checked<{/if}>> 是
                                </label>
                                <label  class="form-inline">
                                    <input class="only_bank" type="radio" name="item[only_bank]" value="0" <{if $item && $item.only_bank != 1}>checked<{/if}>> 否
                                </label>
                            </div>
                        </div>
                        <!--add_2017/12/11_by_wanghaichao_end-->
                        <{/if}>
                        <!--end whc_是否是银行卡特卖商品2017/9/7---->
                    </div>
                </div>
                <!--基本内容结束-->

                <!--自然属性开始-->
                <div id="floor_2" class="panel panel-default">
                    <div class="panel-heading">
                        自然属性
                    </div>
                    <div class="panel-body" id="nature_props">
                        <!-- 自然属性start -->
                        <!-- 自然属性end -->
                    </div>
                </div>
                <!--自然属性结束-->

                <!--详细参数开始-->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        详细参数
                    </div>
                    <div class="panel-body goods-params" id="params">
                        <!-- 详细参数start -->
                        <!-- 详细参数end -->
                    </div>
                </div>
                <!--详细参数结束-->

                <!--其他信息开始-->
                <div id="floor_3" class="panel panel-default">
                    <div class="panel-heading">
                        其他信息
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">库存计数：</label>
                            <div class="radio">
                                <label  class="form-inline">
                                    <input type="radio" name="item[sub_stock]" value='1' disabled="disabled" <{if $item.sub_stock ||!$item.sub_stock}>checked<{/if}> >下单减库存
                                </label>
                                <label  class="form-inline">
                                    <input type="radio" name="item[sub_stock]" value='0' disabled="disabled" <{if !$item.sub_stock}>checked<{/if}>>付款减库存
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 计价单位：</label>
                            <div class="form-inline col-sm-2 right45">
                                <input type="text" name="item[unit]" value="<{$item.unit}>" required class="form-control" maxlength="3" disabled="disabled">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 单品/多规格：</label>
                            <div class="radio">
                                <label  class="form-inline">
                                    <{if $item.item_id}>
                                    <input type="radio" <{if $item.nospec}>checked<{/if}> disabled="true">
                                    <{else}>
                                    <input type="radio" name="item[nospec]" value='1' <{if $item.nospec ||!$item.nospec}>checked<{/if}>>
                                    <{/if}>
                                    单品
                                </label>
                                <label  class="form-inline">
                                    <{if $item.item_id}>
                                    <input type="radio" <{if !$item.nospec}>checked<{/if}> disabled="true">
                                    <{else}>
                                    <input type="radio" name="item[nospec]" value='0' <{if !$item.nospec}>checked<{/if}> >
                                    <{/if}>
                                    多规格
                                </label>
                                <{if $item.item_id}>
                                <input type="hidden" name="item[nospec]" <{if $item.nospec}> value='1'  <{else}> value='0' <{/if}> >
                                <{/if}>
                                <span class="label label-info">选择多规格，则可以添加颜色等销售属性生成多SKU，否则生成单品</span>
                            </div>
                        </div>

                        <!--add_2017/9/23_by_wanghaichao_start-->
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否开启预售：</label>
                            <div class="col-sm-10">
                                <input class="sell_open" type="radio" name="sell_open" value="1" disabled="disabled" <{if $sell_time}>checked<{/if}>> 是
                                <input class="sell_open" type="radio" name="sell_open" value="0" disabled="disabled" <{if !$sell_time}>checked<{/if}>> 否
                            </div>
                        </div>

                        <div class="form-group sell_time_start" <{if !$sell_time}>style="display:none"<{/if}>>
                            <label class="col-md-2 control-label"><{t}>开售时间<{/t}>：</label>
                            <div class="col-sm-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" style="margin-top:-1px" class="form-control glyphicon glyphicon-calendar fa fa-calendar calendar start_reservation" name="item[sell_time]" value="<{$sell_time}>" disabled="disabled">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否开启售卖截止：</label>
                            <div class="col-sm-10">
                                <input class="sell_end" type="radio" name="sell_end" value="1" disabled="disabled" <{if $sell_time_end}>checked<{/if}>> 是
                                <input class="sell_end" type="radio" name="sell_end" value="0" disabled="disabled" <{if !$sell_time_end}>checked<{/if}>> 否
                            </div>
                        </div>

                        <div class="form-group sell_time_end" <{if !$sell_time_end}>style="display:none"<{/if}>>
                            <label class="col-md-2 control-label"><{t}>截止时间<{/t}>：</label>
                            <div class="col-sm-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" style="margin-top:-1px" class="form-control glyphicon glyphicon-calendar fa fa-calendar calendar start_reservation" name="item[sell_time_end]" value="<{$sell_time_end}>" disabled="disabled">
                                </div>
                            </div>
                        </div>

                        <div class="form-group virtual" <{if $item.is_virtual!=1}>style="display:none" <{/if}>>
                            <label class="col-md-2 control-label"><{t}>有效期<{/t}>：</label>
                            <div class="col-sm-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input type="text" style="margin-top:-1px" class="form-control glyphicon glyphicon-calendar fa fa-calendar calendar reservation" style="max-width:100%;" name="item[valid_time]" value="<{$valid_time}>" disabled="disabled">
                                </div>
                            </div>
                        </div>

                        <div class="form-group virtual" <{if $item.is_virtual!=1}>style="display:none" <{/if}>>
                            <label for="" class="col-sm-2 control-label">使用须知：</label>
                            <div class="col-sm-3">
                                <textarea name="item[description]" rows='4' class="form-control" disabled="disabled"><{$item.description}></textarea>
                            </div>
                        </div>
                        <!--add_2017/9/23_by_wanghaichao_end-->

                        <!--add_2017/11/1_by_wanghaichao_start-->
                        <!----设置商品购买限制------->
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">是否开启购买限制：</label>
                            <div class="col-sm-10">
                                <label><input class="is_limit" type="radio" name="is_limit" value="1" disabled="disabled" <{if $item.limit_quantity}>checked<{/if}>> 是</label>
                                <label><input class="is_limit" type="radio" name="is_limit" value="0" disabled="disabled" <{if !$item.limit_quantity}>checked<{/if}>> 否</label>
                            </div>
                        </div>

                        <div class="form-group limit_quantity" <{if !$item.limit_quantity}>style="display:none"<{/if}>>
                            <label class="col-md-2 control-label"><{t}>每个用户限制购买数量<{/t}>：</label>
                            <div class="col-sm-3">
                                <input name="item[limit_quantity]" class="form-control" value="<{$item.limit_quantity}>" disabled="disabled">
                            </div>
                            <span class="label label-info">用户限购数量,0为不限制</span>
                        </div>
                        <!--add_2017/11/1_by_wanghaichao_end-->


                    </div>
                </div>
                <!--其他信息开始-->

                <!--商品标准信息开始-->
                <div id="floor_4" class="panel panel-default panel-default-table">
                    <div class="panel-heading">
                        商品标准信息<span class="label label-info" style="margin-top:1em;margin-left:1em;margin-bottom:1em;">选择多品时，库存为sku库存之和，不可编辑</span><span class="label label-danger" style="margin-top:1em;margin-left:1em;margin-bottom:1em;">标准售价和成本价与结算相关，请准确填写</span>

                    </div>
                    <div class="td">
                        <div class="spec-tree" style="overflow:scroll;">
                            <table cellspacing="0" cellpadding="0" border="0" class="table table-bordered" id="goods-table" style="min-width: 1200px;">
                                <thead>
                                <tr class="small">
                                    <!-- ------加判断是不是虚拟商品----- -->
                                    <{if $item.is_virtual!=1}>
                                    <th class="no-virtual" style="width:8%;">重量(千克[kg])</th>
                                    <{/if}>
                                    <!-- ---------------- -->
                                    <th style="width:10%;">标准售价(元)<span class="text-danger">*</span><i  data-toggle="tooltip" data-placement="top" title="多规格时，标准价要介于SKU最低和价最高价之间；无规格时就是真实售价"><i class="fa fa-question-circle text-aqua"></i></i></th>
                                    <th style="width:10%;">原价(元)</th>
                                    <th style="width:10%;">成本价(元)</th>
                                    <!--add_20170927_by_王衍生_start-->
                                    <th style="width:10%;">供货价</th>
                                    <!--add_20170927_by_王衍生_end-->
                                    <th style="width:10%; <{if !$item || ($item.is_bank && $item.only_bank)}>display:none;<{/if}>" class="bank_price" >银行卡价(元)</th>
                                    <th style="width:8%;">库存(件)<span class="text-danger">*</span></th>
                                    <th style="width:13%;">商品货号</th>
                                    <th style="width:13%;">商家条形码</th>
                                    <!--add_20170927_by_fanglongji_start-->
                                    <th style="width:8%;">服务费率（%）</th>
                                    <!--add_20170927_by_fanglongji_end-->
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <!-- ------加判断是不是虚拟商品----- -->
                                    <{if $item.is_virtual!=1}>
                                    <td class="no-virtual">
                                        <div class="form-group has-feedback" style="margin: 0;">
                                            <input type="number" name="item[weight]" value="<{$item.weight}>" class="form-control price" data-validate-numeric="true" required maxlength="13" disabled="disabled">
                                        </div>
                                    </td>
                                    <{/if}>
                                    <!-- ------ -->
                                    <td>
                                        <div class="form-group has-feedback" style="margin: 0;">
                                            <input type="number" name="item[price]" value="<{$item.price}>" class="form-control price" data-validate-numeric="true" required <{if app::get('sysmall')->getConf('sysmall.setting.modify_price') == 'false'}>disabled="disabled"<{/if}>>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group has-feedback" style="margin: 0;">
                                            <input type="number" name="item[mkt_price]" value="<{$item.mkt_price}>" class="form-control mkt_price" maxlength="13" min="0" required data-validate-numeric="true" disabled="disabled">
                                            <span class="small">
                                                <input type="checkbox" name="item[show_mkt_price]" value="1" <{if $item.show_mkt_price}> checked <{/if}> disabled="disabled" />
                                                展示原价
                                                <label  data-toggle="tooltip" data-placement="top" title="是否在商品详情页展示原价"><i class="fa fa-question-circle text-aqua"></i></label>
                                    </span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" name="item[cost_price]" value="<{$item.cost_price}>" class="form-control cost_price" maxlength="13" min="0" data-validate-numeric="true" disabled="disabled">
                                    </td>
                                    <!--add_20170927_by_王衍生_start-->
                                    <td>
                                        <input type="number" name="item[supply_price]" value="<{$item.supply_price}>" maxlength="30" class="form-control supply_price" disabled="disabled">
                                    </td>
                                    <!--add_20170927_by_王衍生_end-->
                                    <!--add_2017/12/12_by_wanghaichao_start-->
                                    <td class="bank_price" <{if !$item || ($item.is_bank && $item.only_bank)}>style="display:none;"<{/if}>>
                                    <input type="number" name="item[bank_price]" value="<{$item.bank_price}>" class="form-control bank_price" maxlength="13" min="0" data-validate-numeric="true" disabled="disabled">
                                    </td>
                                    <!--add_2017/12/12_by_wanghaichao_end-->
                                    <td nowrap>
                                        <div class="form-group has-feedback small" style="margin: 0;">
                                            <input type="number" value="<{$item.store|default:'0'}>" class="form-control store" name="item[store]" required min="0" data-max="999999" disabled="disabled">
                                            <span class="small">
                                    冻结： <em class="text-orange"><{$item.freez|default:'0'}></em>
                                    </span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" name="item[bn]" value="<{$item.bn}>" class="form-control bn" maxlength="30" disabled="disabled">
                                    </td>
                                    <td>
                                        <input type="text" name="item[barcode]" value="<{$item.barcode}>" maxlength="30" class="form-control barcode" disabled="disabled">
                                    </td>
                                    <!--add_20170927_by_fanglongji_start-->
                                    <td>
                                        <input type="text" readonly="readonly" name="item[service_rates]" value="<{$item.service_rates}>" maxlength="30" class="form-control service_rates" disabled="disabled">
                                    </td>
                                    <!--add_20170927_by_fanglongji_end-->

                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!--商品标准信息结束-->

                <!-- 销售属性start -->
                <div id="floor_5" class="panel panel-default spec-props">
                    <div class="panel-heading">
                        销售属性
                    </div>
                    <div id="update_news" class="clearfix">
                    </div>
                    <div class="panel-body" id="spec_props"></div>
                </div>
                <!-- 销售属性end -->

                <!--商品规格(sku)开始-->
                <div id="floor_6" class="panel panel-default panel-default-table goods-spec">
                    <div class="panel-heading">
                        商品规格(sku)
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;共<b class="product-number"><{$countProducts}></b>种货品</span>
                    </div>

                    <{if $goods_spec_images && count($goods_spec_images)>0}>
                    <div id="goods_spec_images">
                        <{foreach from=$goods_spec_images item=imageid}>
                        <input type="hidden" name="img[<{$imageid}>]" value="<{$imageid|storager:t}>" />
                        <{/foreach}>
                    </div>
                    <{/if}>

                    <!--商品规格sku模版开始-->
                    <textarea id="goodsTpl" style="display:none;">
                        <tr data-pid="{sku_id}">
                          <td>{spec}</td>
                          <td>
                            <div>
                              <input type="hidden" name="{idx}[sku_id]" value="{sku_id}">
                              <input type="number" value="{price}" class="form-control price" name="{idx}[price]" required <{if app::get('sysmall')->getConf('sysmall.setting.modify_price') == 'false'}>disabled="disabled"<{/if}>>
                            </div>
                          </td>
                          <td>
                            <input type="number" value="{mkt_price}" class="form-control mkt_price" name="{idx}[mkt_price]" readonly="readonly">
                          </td>
                          <td>
                            <input type="number" value="{cost_price}" class="form-control cost_price" name="{idx}[cost_price]" readonly="readonly">
                          </td>
                            <!--add_20170927_by_王衍生_start-->
                            <td>
                            <input type="number" value="{supply_price}" class="form-control supply_price" name="{idx}[supply_price]" readonly="readonly">
                            </td>
                            <!--add_20170927_by_王衍生_end-->
                            <!--add_2017/12/11_by_wanghaichao_start-->
                          <td class="bank_price" <{if !$item || ($item.is_bank && $item.only_bank)}>style="display:none;"<{/if}>>
                            <input type="number" value="{bank_price}" class="form-control bank_price" name="{idx}[bank_price]" readonly="readonly">
                            </td>
                            <!--add_2017/12/11_by_wanghaichao_end-->
                          <td nowrap>
                            <div>
                              <input type="number" value="{store}" class="form-control store" name="{idx}[store]" required min="0" readonly="readonly"> <span class="small">冻结： <em class="text-orange">{freez}</em></span>
                            </div>
                          </td>
                          <td>
                            <input type="text" value="{bn}" class="form-control bn" name="{idx}[bn]" readonly="readonly">
                          </td>
                          <td>
                            <input type="text" value="{barcode}" class="form-control barcode" name="{idx}[barcode]" readonly="readonly">
                          </td>
                            <!--add_20170927_by_fanglongji_start-->
                          <td>
                            <input type="text" readonly="readonly" value="{service_rates}" class="form-control service_rates" name="{idx}[service_rates]">
                          </td>
                            <!--add_20170927_by_fanglongji_end-->
                        </tr>
                      </textarea>
                    <!--商品规格sku模版结束-->

                    <div class="td">
                        <div class="spec-title" style="margin-top:1em;margin-left:1em;">
                            <div class="row form-group-sm">
                                <span class="pull-left">
                                    &nbsp;&nbsp;批量填充
                                    <label  data-toggle="tooltip" data-placement="top" title="如果sku有多页，批量填充只能填充本页">&nbsp;
                                        <i class="fa fa-question-circle text-aqua"></i>&nbsp;
                                    </label>
                                </span>
                                <div class="col-sm-2" style="width:14%; padding:0 5px 10px 0;">
                                    <input type="number" name="spec_price" class="form-control" placeholder="销售价" <{if app::get('sysmall')->getConf('sysmall.setting.modify_price') == 'false'}>readonly="readonly"<{/if}> />
                                </div>
                                <div class="col-sm-2" style="width:10%; padding:0 5px 10px 0;">
                                    <input type="number" name="spec_mkt_price" class="form-control" placeholder="原价" readonly="readonly" />
                                </div>
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 5px 0;"><input type="number" name="spec_cost_price" class="form-control" placeholder="成本价" readonly="readonly"></div>
                                <!--add_2018/6/11_by_王衍生_start-->
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 5px 0;"><input type="number" name="spec_supply_price" class="form-control" placeholder="供货价" readonly="readonly"></div>
                                <!--add_2018/6/11_by_王衍生_start-->
                                <!--add_2017/12/11_by_wanghaichao_start-->
                                <div class="col-sm-2 bank_price" style="width:10%; padding: 0 5px 5px 0;<{if !$item || ($item.is_bank && $item.only_bank)}>display:none;<{/if}>"><input type="number" name="spec_bank_price" class="form-control" placeholder="银行卡价" readonly="readonly"></div>
                                <!--add_2017/12/11_by_wanghaichao_end-->
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 10px 0;"><input type="number" name="spec_store" class="form-control" placeholder="库存" readonly="readonly"></div>
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 10px 0;"><input type="text" name="spec_bn" class="form-control" placeholder="商品货号" readonly="readonly"></div>
                            </div>
                            <div class="row form-group-sm">
                                <span class="pull-left" style="width: 84px;height: 25px;"></span>
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 10px 0;"><input type="text" name="spec_barcode" class="form-control" placeholder="条形码" readonly="readonly"></div>
                                <!--add_20170927_by_fanglongji_start-->
                                <div class="col-sm-2" style="width:10%; padding: 0 5px 10px 0;"><input type="text" readonly="readonly" name="spec_service_rates" class="form-control" placeholder="服务费率" readonly="readonly"></div>
                                <!--add_20170927_by_fanglongji_end-->
                                <button type="button" class="btn btn-primary fill-action btn-xs">确定</button>
                            </div>
                        </div>
                        <div class="spec-tree" style="overflow:scroll;">
                            <table cellspacing="0" cellpadding="0" border="0" class="table table-bordered" id="goods-sku-table" style="min-width: 1200px">
                                <thead>
                                <tr>
                                    <th style="width: 8%;">规格值</th>
                                    <th style="width:10%;">销售价 <span class="text-danger">*</span></th>
                                    <th style="width:10%;">原价</th>
                                    <th style="width:10%;">成本价</th>
                                    <th style="width:10%;">供货价</th>
                                    <!--add_2017/12/11_by_wanghaichao_start-->
                                    <th class="bank_price" style="width:10%;<{if !$item || ($item.is_bank && $item.only_bank)}>display:none;<{/if}>">银行卡价</th>
                                    <!--add_2017/12/11_by_wanghaichao_end-->
                                    <th style="width:8%;">库存 <span class="text-danger">*</span></th>
                                    <th style="width:13%;">商品货号</th>
                                    <th style="width:13%;">条形码</th>
                                    <!--add_20170927_by_fanglongji_start-->
                                    <th style="width:8%;">服务费率（%）</th>
                                    <!--add_20170927_by_fanglongji_end-->
                                </tr>
                                </thead>
                                <tbody id="dataNode">
                                </tbody>
                            </table>
                            <div class="text-center gridlist-footer">
                                <ul id="pager" class="pagination">
                                    <li class="prev">
                                        <a title="上一页" href="javascript:void(0)">&lt;上一页</a>
                                    </li>
                                    <li class="next">
                                        <a title="下一页" href="javascript:void(0)">下一页&gt;</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!--商品规格(sku)结束-->

                <!--商品描述开始-->
                <div id="floor_7" class="panel panel-default">
                    <div class="panel-heading">
                        商品描述
                    </div>
                    <div class="bs-example bs-example-tabs">
                        <ul id="myTab" class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active"><a href="#home" id="home-tab" role="tab" data-toggle="tab" aria-controls="home" aria-expanded="true">电脑端</a></li>
                            <li role="presentation" class=""><a href="#profile" role="tab" id="profile-tab" data-toggle="tab" aria-controls="profile" aria-expanded="false">移动端</a></li>
                        </ul>
                        <div id="myTabContent" class="tab-content">
                            <div role="tabpanel" class="tab-pane fade active in" id="home" aria-labelledby="home-tab">
                                <textarea name="item[desc]" style="width:100%;" class="rich-editor" disabled="disabled"><{$item.pc_desc}></textarea>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="profile" aria-labelledby="profile-tab">
                                <textarea name="item[wap_desc]" class="rich-editor" style="width:100%;" disabled="disabled"><{$item.wap_desc}></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!--商品描述结束-->

                <!--店铺自定义分类开始-->
                <div id="floor_8" class="panel panel-default">
                    <div class="panel-heading">
                        店铺自定义分类
                        <label  data-toggle="tooltip" data-placement="top" title="可以选择多个店铺自定义分类的叶子节点分类"><i class="fa fa-question-circle text-aqua"></i></label>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">店铺中分类：</label>
                            <div class="col-sm-3">
                                <select name="item[shop_cids][]" multiple id="act-selectshopcat" class="form-control">
                                    <{foreach from=$shopCatList item=shop_cat}>
                                    <{if $shop_cat.children}>
                                    <optgroup label='<{$shop_cat.cat_name}>'>
                                        <{else}>
                                        <option value='<{$shop_cat.cat_id}>'
                                        <{if $shop_cat.selected}>
                                        selected=selected
                                        <{/if}>
                                        ><{$shop_cat.cat_name}></option>
                                        <{/if}>

                                        <{if $shop_cat.children}>
                                        <{foreach from=$shop_cat.children item=shop_cat_children}>
                                        <option value='<{$shop_cat_children.cat_id}>'
                                        <{if $shop_cat_children.selected}>
                                        selected
                                        <{/if}>
                                        ><{$shop_cat_children.cat_name}></option>
                                        <{/foreach}>
                                        <{/if}>

                                        <{if $shop_cat.children}>
                                    </optgroup>
                                    <{/if}>
                                    <{/foreach}>
                                </select>
                            </div>
                            <span class="label label-info">还没有店铺分类？点击</span> <a href="<{url action=topshop_ctl_item_cat@index}>" target="_blank"> 添加店铺分类</a>
                        </div>
                    </div>
                </div>
                <!--店铺自定义分类结束-->
				
				<!----------虚拟商品判断------>
				<{if $item.is_virtual!=1}>
				<div id="floor_9" class="panel panel-default no-virtual" style="display: none;">
					<div class="panel-heading">
						商品物流信息
						<label  data-toggle="tooltip" data-placement="top" title="每个商品都可以关联一个运费模板，前台下单结算时如果商品运费模板相同则在一个运费规则里计算，运费模板不同则叠加计算运费"><i class="fa fa-question-circle text-aqua"></i></label>
					</div>
					<div class="panel-body">
						<div class="form-group">
							<label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 运费模板：</label>
							<div class="col-sm-3">
								<button type="button" data-toggle="modal" data-target="#dlytmplDialog" class="btn btn-default btn-sm btn-brand" disabled>选择运费模板</button>&nbsp;&nbsp;<span class="dlytmpl-choose-txt" data-id="<{$item.dlytmpl_id}>"><{$dlytmpls['data'][$item['dlytmpl_id']]['name']}></span>
								<{include file="topshop/item/dlytmpl.html"}>
								<input type="hidden" name="item[dlytmpl_id]" value="<{$item.dlytmpl_id}>" />
								<!--<select name="item[dlytmpl_id]" required id="act-selectshopcat" class="form-control">-->
									<!--<option value="" ><{t}>请选择运费模版<{/t}></option>-->
									<!--<{foreach from=$dlytmpls.data item=dly}>-->
									<!--<option value="<{$dly.template_id}>" <{if $dly.template_id==$item.dlytmpl_id}> selected <{/if}>><{$dly.name}></option>-->
									<!--<{/foreach}>-->
								<!--</select>-->
							</div>
							<span class="label label-info">还没有运费模板？点击</span> <a href="<{url action=topshop_ctl_shop_dlytmpl@index}>" target="_blank"> 添加运费模板</a>
						</div>
					</div>
				</div>
				<{else}>
				<input type="hidden" value="0" name="item[dlytmpl_id]">
				<{/if}>
				<!------虚拟商品判断-------->
				
                <!--结算信息开始-->
                <div id="floor_10" class="panel panel-default">
                    <div class="panel-heading">
                        结算信息
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label"><span class="txt-required">*</span> 收入类型：</label>
                            <div class="col-sm-4">
                                <select name="item[incoming_type]" required class="form-control" <{if $item.incoming_type}>disabled<{/if}>>
                                <option value="" ><{t}>请选择<{/t}></option>
                                <{foreach from=$taxrate item=rate key=key}>
                                <option value="<{$key}>" <{if $item.incoming_type==$key}>selected<{/if}>><{$rate.src}></option>
                                <{/foreach}>
                                </select>
                            </div>
                            <span class="label label-danger">保存后不能修改，请谨慎填写，如有疑问，请联系电商公司确认，以免导致结算有误</span>
                        </div>
                    </div>
                </div>
                <!--结算信息结束-->
            </div>
            <!--商品信息结束-->

            <{if $item.approve_status =='refuse' && $item.reason}>
            <div class="panel panel-default">
                <div class="panel-heading">审核结果</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label class="col-sm-2 control-label"><{t}>驳回原因<{/t}>：</label>
                        <div class="col-sm-10 "><{$item.reason}></div>
                    </div>
                </div>
            </div>
            <{/if}>

            <{if $item.approve_status != "pending"}>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-lg btn-block save-action" style="margin-left:1em;">保存</button>
            </div>
            <{/if}>
        </div>
		<!--面板body结束-->
    </div>
	<!--面板结束-->
</form>
<!--表单结束-->

<!--快捷导航开始-->
<div class="panel panel-default goods-info-floor">
    <div class="panel-heading">快捷导航<i class="glyphicon glyphicon-remove" title="关闭"></i></div>
    <div class="panel-body">
        <ul>
            <li><a href="javascript:void(0);" data-id="floor_1">基本内容</a></li>
            <li><a href="javascript:void(0);" data-id="floor_3">其他信息</a></li>
            <li><a href="javascript:void(0);" data-id="floor_4">商品标准信息</a></li>
            <li><a href="javascript:void(0);" data-id="floor_7">商品描述</a></li>
            <li><a href="javascript:void(0);" data-id="floor_8">店铺自定义分类</a></li>
			<li><a href="javascript:void(0);" data-id="floor_9" style="display: none;">商品物流信息</a></li>
        </ul>
    </div>
    <div class="floor-icon-box">
        <div class="icon-show">
            <icon class="glyphicon glyphicon-chevron-left"></icon>
        </div>
    </div>
</div>
<!--快捷导航结束-->

<{script src="md5.js" app="desktop"}>
<{script app="toputil" src="jquery-catselect.js"}>
<script>
    function categoryCallback (instance, option) {
        $('#catDialog').find('.btn-primary').prop('disabled', option.hasChild ? true : false);
    }

    $('.rich-editor').summernote({
        height: 400,
        tabsize: 2,
        uploadURI: '<{url action=toputil_ctl_image@uploadImages from=shop}>',
        uploadPerfix: 'upload_file'
    });

    //用json存取数据
    var GoodsSpec;
    var goods_info;// = <{if $goods_info}><{$goods_info}><{else}>{}<{/if}>;
    var Products;// = <{if $products}><{$products}><{else}>{}<{/if}>;
    var Spec;// = <{if $selection_spec_json}><{$selection_spec_json}><{else}>{}<{/if}>;
    var activeProducts;// = <{if $activeProducts}><{$activeProducts}><{else}>{}<{/if}>;
    var isnospec = $('input[name="item[nospec]"]:checked').val() == '1' ? true : false; //记录是否为单商品规格
    $("#specification").on('keydown',function(){
        if(event.keyCode==13)
        {
            return false;
        }
    });
    function ajaxSubmit (e) {

        var form = e.target;
        e.preventDefault();
        $.post(form.action, $(form).serialize(), function(rs) {
            // rs = JSON.parse(rs);
            $(form).find('button[type=submit]').prop('disabled', false);
            if(rs.error) {
                $('#messagebox').message(rs.message, 'error');
                return;
            }
            else if(rs.success) {
                $('#messagebox').message(rs.message, 'success');
            }
            if(rs.redirect) {
                location.href = rs.redirect;
            }
        });
    }

    var catId = 0;
    $('#catDialog').find('.btn-primary').on('click', function(e) {
        var dialog = $('.cat-select').data('_catselect_');
        catId = dialog.selectedParam.val();
        if(catId) {
            $('.act-handle span').text(dialog.selectedList.text());
            $('.act-handle input').val(catId);
        }
        if(dialog.selectedParam.val() == '') {
            return $('#messagebox').message('请先选择一个类目');
        }
        $('.act-handle span').text(dialog.selectedList.text());
        $('.act-handle input').val(catId);
        $.post('<{url action="topshop_ctl_sku@getNatureProps"}>','cat_id='+catId+'&item_id='+'<{$item.item_id}>',function(rs){
            if(rs.length<=0){
                $('#nature_props').parent('.panel').hide();
            }else{
                $('#nature_props').parent('.panel').show();
            }
            $('#nature_props').html(rs);
            $('#nature_props select').attr('disabled', true);
        });
        $.post('<{url action="topshop_ctl_sku@getParams"}>','cat_id='+catId+'&item_id='+'<{$item.item_id}>',function(rs){
            if(rs.length<=0){
                $('#params').parent('.panel').hide();
            }else{
                $('#params').parent('.panel').show();
            }
            $('#params').html(rs);
            $('#params input').attr('disabled', true);
        });
        $.post('<{url action="topshop_ctl_sku@getSpecProps"}>','cat_id='+catId+'&item_id='+'<{$item.item_id}>',function(rs){
            if(rs.length<=0){
                $('#spec_props').parent('.panel').hide().next().hide();
                //return false;
            }else{
                $('#spec_props').parent('.panel').show().next().show();
            }
            $('#spec_props').html(rs);
            $('#spec_props input').prop('disabled', 'disabled');

            $.post('<{url action="topshop_ctl_sku@set_spec_index"}>','nospec=<{$item.nospec}>&cat_id='+catId+'&item_id='+'<{$item.item_id}>',function(rs){
                if(rs){
                    Products = rs.products ? rs.products : {} ;
                    Spec = rs.selection_spec_json ? rs.selection_spec_json : {};
                    activeProducts = rs.activeProducts ? rs.activeProducts : {};
                    goods_info={};
                }
                new goodsSpecTree('#specification');
                $('#spec_props .select-image').prop('href', 'javascript:;').removeAttr('data-toggle');
            });
        });
        //获取品牌
        $.post('<{url action="topshop_ctl_item@ajaxGetBrand"}>','cat_id='+catId,function(rs){
            if(rs && !$.isEmptyObject(rs)) {
                if(rs.error) {
                    $('.panel-outter>.panel-body').addClass('hide');
                    $('#specification button[type=submit]').prop('disabled', true);
                    return $('#messagebox').message(rs.message);
                }
                $('.panel-outter>.panel-body').removeClass('hide');
                $('#specification button[type=submit]').prop('disabled', false);
                var brandid = '<{$item.brand_id}>';
                var brandList = $('.list-group-brand');
                var brandStr = '';
                $.each(rs, function(k, v) {

                    if(v.brand_id==brandid)
                    {
                        $('.brand-choose-txt').html(v.brand_name);
                        $('.brand-choose-txt').attr('data-id', v.brand_id);
                        $('.brand-foot span').html(v.brand_name);
                        $('input[name="item[brand_id]"]').val(v.brand_id);
                        brandStr += '<a href="javascript:void(0);" class="list-group-item brand-item active" data-brandId='+v.brand_id+'>'+v.brand_name+'</a>';
                    }else{
                        brandStr += '<a href="javascript:void(0);" class="list-group-item brand-item" data-brandId='+v.brand_id+'>'+v.brand_name+'</a>';
                    }
                });
                brandList.html(brandStr);
                $('.brand-select').catselect({
                        url: '<{url action="topshop_ctl_item@ajaxGetBrand"}>',
                        name: 'cat_id',
                        data: catId,
                    <{if $callback}>
                    onchange: function (instance, option) { window['<{$callback}>'] && <{$callback}>(instance, option); },
            <{/if}>
                searchbox: '.form-control',
                    selectedList: '.brand-foot span',
                    selectedParam: '.brand-foot input[type=hidden]'
            });
            }
            else {
                $('.brandErr').text('该类目下面的品牌为空！');
                $('.panel-outter>.panel-body').addClass('hide');
                $('#specification button[type=submit]').prop('disabled', true);
            }
        });
        $('.brand-choose-txt').html('');
        $('.brand-choose-txt').attr('data-id', '');
        $('input[name="item[brand_id]"]').val('');
        $('#catDialog').modal('hide');
    }).trigger('click');

    $('.act-listtime').on('focus',function(){
        $(this).parents('.radio').find('input[type=radio]')[0].checked=true;
    });

    var preTotalStore = 0;
    var curStore = 0;
    // 商品规格编辑
    //table翻页组件
    var Pager = new Class({
        options: {
            tpl: '#goodsTpl',
            pager: '#pager',
            current: 1,
            paging: 10
        },
        init: function(container, data, options) {
            this.container = $(container);
            this.setOptions(options);
            this.data = data;
            if(!this.data) return;
            this.total = this.data.length;
            this.paging = this.options.paging;
            this.totalPage = Math.ceil(this.total/this.paging);
            this.tpl = $(this.options.tpl).val();
            this.pager = $(this.options.pager);
            this.current = this.options.current;
            this.render(this.current);
            this.attach();
        },
        render: function(n) {
            this.goPage(n);
            this.updatePager();

        },
        attach: function() {
            var self = this;
            this.pager.off('click').on('click', function(e) {
                var target = $(e.target);
                var n;
                if(target.hasClass('disabled') || target.parent('.disabled').size()) {
                    return;
                }

                if(target.hasClass('prev') || target.parent('.prev').size()) {
                    n = self.current - 1;
                }
                else if(target.hasClass('next') || target.parent('.next').size()) {
                    n = self.current + 1;
                }
                else if(target.hasClass('flip')) {
                    n = parseInt(target.text());
                }
                else {
                    return;
                }
                self.render(n);
            });
        },
        goPage: function(n) {
            var html = [];
            if(n < 1) n = 1;
            else if(n > this.totalPage) n = this.totalPage;
            if(this.total) {
                for(var i = this.paging * (n - 1), j = this.paging * n, l = this.total, d; i < j && i < l; i++) {
                    d = this.data[i];
                    $.each(d, function(k, v) {
                        if($.type(v) === 'object') d[k] = JSON.stringify(v);
                    });
                    html.push(substitute(this.tpl, d));
                }
                this.current = n;
            }
            this.container.html(html);
            curStore = getPreTotalStore();
            preTotalStore = $('input[name="item[store]"]').val() - curStore;
        },
        updatePager: function() {
            if(this.total > 10) {
                this.pager.css('display','');
                var pageHtml = this.createLink();
                this.pager.html(pageHtml);
            }
            else this.pager.css('display', 'none');
        },
        pageLink:function(from, to){
            var links = [];
            for(var i = from; i <= to; i++){
                links.push(this.current == i ? '<li><span class="current">'+i+'</span></li>' : '<li><a class="flip" href="javascript:void(0)">'+i+'</a></li>');
            }
            return links.join(' ');
        },
        createLink: function() {
            var prev = this.pager.find('.prev'),
                next = this.pager.find('.next'),
                links = [],
                t=this.totalPage,
                c=this.current;
            if(c == 1) {
                prev.addClass('disabled');
                next.removeClass('disabled');
            }
            else if(c == t) {
                prev.removeClass('disabled');
                next.addClass('disabled');
            }
            else {
                prev.removeClass('disabled');
                next.removeClass('disabled');
            }
            if(t<=10){
                links.push(this.pageLink(1,t));
            }else{
                if(t-c<8){
                    links.push(this.pageLink(1,3));
                    links.push(this.pageLink(t-8,t));
                }else if(c<8){
                    links.push(this.pageLink(1,Math.max(c+3,8)));
                    links.push(this.pageLink(t-1,t));
                }else{
                    links.push(this.pageLink(1,3));
                    links.push(this.pageLink(c-2,c+3));
                    links.push(this.pageLink(t-1,t));
                }
            }
            return prev.outerHtml() + links.join('...') + next.outerHtml();
        }
    });

    //展示货品数据
    var goodsSpecTree = new Class({
        options: {
            speclist:'.speclist',
            specIMG: '.spec-img',
            specMap: '#dataNode',
            switchTrigger: '.typelist',
            switchContent: '.spec-wrap',
            number: '.product-number',
            specFillBtn: '.fill-action'
        },
        count: 0,
        init: function(container, options){
            this.setOptions(options);
            this.container = $(container);
            this.speclist = this.container.find(this.options.speclist);
            this.specLength = this.speclist.length;
            if(!this.specLength) return;
            this.specIMG = this.container.find(this.options.specIMG);
            this.specMap = $(this.options.specMap);
            this.specFillBtn = $(this.options.specFillBtn);
            this.switchTriggers = this.container.find(this.options.switchTrigger).children();
            this.switchPanels = this.container.find(this.options.switchContent).children();
            // this.selectAll = this.container.find('.selectAll input[type=checkbox]');
            this.number = this.container.find(this.options.number);
            this.newProduct = {};
            this.attach();
            // this.build(this.speclist);
            this.createAllGoods(false);
        },
        attach: function() {
            var self = this;
            for(var i = 0; i < this.specLength; i++) {
                (function(i) {
                    var trigger = this.switchTriggers.eq(i),
                        panel = this.switchPanels.eq(i),
                        // sel = this.selectAll.eq(i),
                        list = this.speclist.eq(i);
                    // trigger.on('click', function(e) {
                    //     $(this).addClass('act').siblings('.act').removeClass('act');
                    //     panel.show().siblings().hide();
                    // });
                    var chks = list.find('input[type=checkbox]');
                    // sel.on('change', function(e) {
                    //     chks.filter(function(){return !this.disabled;}).set('checked', this.checked);
                    //     self.build(chks, list, i, trigger);
                    // });
                    chks.on('change', function(e) {
                        self.build(this, $(this).parents(self.options.speclist), i, trigger);
                        self.createAllGoods();
                    });
                    chks.on('click', function(e) {
                        self.toggleEdit(this, i);
                    });

                }).call(this, i);
            }

            var checked = this.speclist.find('input:checked').eq(0);
            checked.trigger('change');

            this.container.on('change', '.edit-spec-name', function(e) {
                var str = this.name;
                var id = str.match(/\[([^\]]*)\]/)[1];

                self.specIMG.find('[data-id=' + id + ']').find('.spec-name').text(this.value);

                id = id.split('_');
                Spec[id[0]].option[id[1]].spec_value = this.value;
            })
                .on('click', '.clean:not(.disabled)', function(e) {
                    var p = this.parent('tr');
                    p.find('input[type=text], input[type=number]').val('');
                    // p.find('input[type=checkbox]').val('false').prop('checked', false);
                    var uid = this.attr('data-uid');
                    $.each(self.products, function(i, p) {
                        if(p.idx == uid) {
                            self.products[i] = {
                                idx: uid,
                                sku_id: p.sku_id,
                                spec: p.spec
                            };
                            // self.products.erase(p);
                        }
                    });
                    var oldProduct = $.extend(true, {}, Products[uid]);
                    Products[this.attr('data-uid')] = {
                        sku_id: 'new',
                        spec_desc: oldProduct.spec_desc
                    };

                    // delete Products[uid];
                });
            // this.specIMG.on('change', 'input[type=text], input[type=number]', function(e) {
            //   var str = this.name;
            //   var id = str.match(/\[([^\]]*)\]/)[1];
            //   id = id.split('_');
            //   Spec[id[0]].option[id[1]].spec_value = this.value;
            // });
            this.specMap
            // .on('blur', 'input[type=text], input[type=number]', function(e) {
            //     if(!self.validate(this)) {
            //       (function(){this.focus()}).delay(0, this);
            //       return false;
            //     }
            // })
                .on('change', 'input[type=text], input[type=number]', function(e) {
                    var str = this.name;
                    var uid = str.split('[')[0];
                    var prop = str.match(/\[([^\]]*)\]/)[1];
                    self.storeData(this, uid, prop);
                });
            //批量填充规格
            this.specFillBtn.on('click', function(){
                var specPrice = $.trim($('input[name="spec_price"]').val());
                var specMktPrice = $.trim($('input[name="spec_mkt_price"]').val());
                var specCostPrice = $.trim($('input[name="spec_cost_price"]').val());
                var specStore = $.trim($('input[name="spec_store"]').val());
                var specBn = $.trim($('input[name="spec_bn"]').val());
                var specBarcode = $.trim($('input[name="spec_barcode"]').val());
                /*add_20170927_by_fanglongji_start*/
                var specServiceRates = $.trim($('input[name="spec_service_rates"]').val());
                /*add_20170927_by_fanglongji_end*/
                /*add_2017/12/11_by_wanghaichao_start*/
                var specBankPrice = $.trim($('input[name="spec_bank_price"]').val());
                /*add_2017/12/11_by_wanghaichao_end*/
                /*add_2017/12/11_by_王衍生_start*/
                var specSupplyPrice = $.trim($('input[name="spec_supply_price"]').val());
                /*add_2017/12/11_by_王衍生_end*/
                if(specPrice != ''){
                    $('.goods-spec').find('input[name$="[price]"]').each(function(){
                        $(this).val(specPrice);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_price"]').val('');
                }
                if(specMktPrice != ''){
                    $('.goods-spec').find('input[name$="[mkt_price]"]').each(function(){
                        $(this).val(specMktPrice);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_mkt_price"]').val('');
                }
                if(specCostPrice != ''){
                    $('.goods-spec').find('input[name$="[cost_price]"]').each(function(){
                        $(this).val(specCostPrice);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_cost_price"]').val('');
                }
                if(specStore != ''){
                    $('.goods-spec').find('input[name$="[store]"]').each(function(){
                        $(this).val(specStore);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_store"]').val('');
                }
                if(specBn != ''){
                    $('.goods-spec').find('input[name$="[bn]"]').each(function(){
                        $(this).val(specBn);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_bn"]').val('');
                }
                if(specBarcode != ''){
                    $('.goods-spec').find('input[name$="[barcode]"]').each(function(){
                        $(this).val(specBarcode);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_barcode"]').val('');
                }
                /*add_20170927_by_fanglongji_start*/
                if(specServiceRates != ''){
                    $('.goods-spec').find('input[name$="[service_rates]"]').each(function(){
                        $(this).val(specServiceRates);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_service_rates"]').val('');
                }
                /*add_20170927_by_fanglongji_end*/
                /*add_2017/12/11_by_wanghaichao_start*/
                if(specBankPrice!= ''){
                    $('.goods-spec').find('input[name$="[bank_price]"]').each(function(){
                        $(this).val(specBankPrice);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_bank_price"]').val('');
                }
                /*add_2017/12/11_by_wanghaichao_end*/
                /*add_2017/12/11_by_王衍生_start*/
                if(specSupplyPrice!= ''){
                    $('.goods-spec').find('input[name$="[supply_price]"]').each(function(){
                        $(this).val(specSupplyPrice);
                        $(this).trigger('change');
                    });
                    $('input[name="spec_supply_price"]').val('');
                }
                /*add_2017/12/11_by_王衍生_end*/
                setTotalStore();
            });
            $(document.body).on('click', '.save-action', function(e) {
                var keys = [], i = 0, j = self.products.length, k, l = self.props.length, p, attr, flag;
                for(; i < j; i++) {
                    //flag = false;
                    p = self.products[i];
                    // if(!p.bn) {
                    //   for(k = 0; k < l; k++) {
                    //     attr = self.props[k];
                    //     if(attr === 'sku_id' || attr === 'bn' || !p[attr] || p[attr] === 'false') {
                    //       flag = true;
                    //       continue;
                    //     }
                    //     alert('请填写"' + p.spec + '"商家编码。');
                    //     try{
                    //       self.specMap.find('input[name="' + p.idx + '[bn]"]').focus();
                    //     } catch(e) {}
                    //     return;
                    //     // flag = 1;
                    //     // break;
                    //   }
                    // }
                    // if(flag === 1) return;
                    //if(flag === true) continue;
                    //else
                    keys.push(p.idx);
                }
                // if(flag === 1) return;
                $.each(Spec, function(k, v) {
                    $.each(v.option, function(m, l) {
                        if(l.checked === false) delete Spec[k].option[m];
                    });
                });
                var writecount = 0;
                var isprice = true;
                var isstore = true;
                var p_pricecount = 0;
                var p_storecount = 0;
                var new_pricecount = 0;
                var new_storecount = 0;
                $.each(Products, function(k, v){
                    if(keys.indexOf(k) == -1) {
                        delete Products[k];
                    } else{ // if(Products[k].sku_id != "new")
                        if((typeof(Products[k].price) == 'undefined' || typeof(Products[k].cost_price) == 'undefined' || typeof(Products[k].mkt_price) == 'undefined' || typeof(Products[k].store) == 'undefined') && Products[k].bn == "" && (Products[k].barcode == null || Products[k].barcode == "")) {
                            delete Products[k];
                        } else if(typeof(Products[k].bn) == 'undefined' && typeof(Products[k].barcode) == 'undefined' && Products[k].price == "" && Products[k].cost_price == "" && Products[k].mkt_price == "" && Products[k].store == "" ){
                            delete Products[k];
                        } else {
                            if(Products[k].price != "" || Products[k].cost_price != "" || Products[k].mkt_price != "" || Products[k].store != "" || Products[k].bn != "" || (Products[k].barcode != null && Products[k].barcode != "")) {
                                if(Products[k].price == "") {
                                    isprice = false;
                                }
                                if(Products[k].store == "") {
                                    isstore = false;
                                }
                                p_pricecount = Products[k].price == "" ? p_pricecount + 1 : p_pricecount > 0 ? p_pricecount - 1 : p_pricecount;
                                p_storecount = Products[k].store == "" ? p_storecount + 1 : p_storecount > 0 ? p_storecount - 1 : p_storecount;
                                writecount ++;
                            } else {
                                delete Products[k];
                            }
                        }
                    }
                });

                $('#dataNode').find('tr[data-pid="new"]').each(function(){
                    var goodsinfo_input = $(this).find('input[type="number"], input[type="text"]');
                    var isflag = false;
                    var empty_count = 0;
                    goodsinfo_input.each(function(){
                        if($(this).val() != "" && $(this).val() != null) {
                            isflag = true;
                        } else {
                            empty_count ++;
                        }
                    });
                    if(isflag) {
                        writecount ++;
                        if($(goodsinfo_input[0]).val() == "")  {
                            isprice = false;
                        }
                        if($(goodsinfo_input[3]).val() == "") {
                            isstore = false;
                        }
                        new_pricecount = $(goodsinfo_input[0]).val() == "" ? new_pricecount + 1 : new_pricecount > 0 ? new_pricecount - 1 : new_pricecount;
                        new_storecount = $(goodsinfo_input[3]).val() == "" ? new_storecount + 1 : new_storecount > 0 ? new_storecount - 1 : new_storecount;
                    } else if(empty_count == goodsinfo_input.length) {
                        var obj = $(this).find('input[type="hidden"]').attr('name');
                        obj = obj.substr(0, obj.indexOf('['));
                        delete Products[obj];
                    }
                });
                self.saveNewProduct(keys);
                if(!isnospec) {
                    if(keys.length > 0 && (writecount <= 0)) {
                        $('#messagebox').message('至少填写一种商品规格');
                        return false;
                    }
                    if(!isprice || p_pricecount > 0 || new_pricecount > 0) {
                        $('#messagebox').message('请填写商品规格对应的销售价格');
                        return false;
                    }
                    /*if(!isstore || p_storecount > 0 || new_storecount > 0) {
                     $('#messagebox').message('请填写商品规格对应的库存');
                     return false;
                     }*/
                }
                var max = $('input[name="item[store]"]').attr('data-max');
                var msg = '商品库存数量之和要小于等于' + max;
                if(Number($('input[name="item[store]"]').val()) > Number(max)) {
                    if(isnospec) {
                        msg = '库存数量要小于等于' + max;
                        $('input[name="item[store]"]').focus();
                    }
                    $('#messagebox').message(msg);
                    return false;
                }
            });
        },
        build: function(element, parent, i, trigger) {
            // var d = new Date();
            var id = parent.attr('data-spec-id');
            if(element.length) element.each(function(el){
                this.storeSpec(el, id, parent);
            }, this);
            else {
                this.storeSpec(element, id, parent);
            }
            // this.toggleEdit(element, i);
            trigger && trigger.find('i').text(parent.find('input[type=checkbox]:checked').length);
            this.createSpecGrid(parent, i, id);
            // this.createAllGoods();
        },
        toggleEdit: function(element) {
            var parent = $(element).parent();
            var specname = parent.find('.spec-name');
            var editSpecname = parent.find('.edit-spec-name');
            var editImg = parent.find('img');

            if(specname.hasClass('hide')) {
                specname.removeClass('hide');
                editSpecname.addClass('hide');
                editImg.removeClass('active');
            }
            else {
                specname.addClass('hide');
                editSpecname.removeClass('hide');
                editImg.addClass('active');
            }
        },
        storeSpec: function(el, id, parent) {
            var sid = el.value;
            if(el.checked) {
                if(!Spec[id]) {
                    Spec[id] = {
                        spec_name: parent.attr('data-spec-name'),
                        spec_id: id,
                        show_type: parent.attr('data-spec-type'),
                        option: {}
                    };
                }
                if(!Spec[id].option[sid]) {
                    Spec[id].option[sid] = {
                        // private_spec_value_id: el.name,
                        spec_value: el.title,
                        spec_value_id: sid
                    };
                    if(Spec[id].show_type == 'image') $.extend(Spec[id].option[sid], {
                        spec_image: parent.find('input[key=spec_image_' + sid + ']').val(),
                        spec_image_url: parent.find('img[key=spec_img_' + sid + ']').attr('src')
                    });
                }
                else delete Spec[id].option[sid].checked;
            }
            else if(Spec[id]) {
                Spec[id].option[sid].checked = false;
            }
        },
        createAllGoods: function(needs) {
            var self = this;
            this.specElements = [];
            this.speclist.each(function(index) {
                var checkBox = $(this).find('input[type=checkbox]:checked');
                if(checkBox.length > 0) {
                    self.specElements.push({
                        id: $(this).attr('data-spec-id'),
                        name: $(this).attr('data-spec-name'),
                        input: checkBox
                    });
                }
            });

            this.products = [];
            var length = this.specElements.length;
            if(length == this.specLength) {
                this.processProducts(this.specElements, 0, length);
            }
            else if(needs !== false) {
                return $('#messagebox').message('每个规格项至少选中一项，才能组合成完整的货品信息。');
            }
            this.number.text(this.products.length);
            this.createGoodsGrid();

            this.count = 0;
            if(this.products.length && goods_info.length) {
                this.products.some(function(v, i) {
                    if(v.bn) {
                        var n = v.bn.match(/^.+\-(\d+)$/);
                        if(n && n[1]) {
                            self.count = Math.max(self.count, Number(n[1]) + 1);
                            return false;
                        }
                    }
                    return true;
                });
            }
        },
        createSpecGrid: function(list, i, spec_id) {
            var spec = Spec[spec_id];
            var html = ['<thead>'];
            html.push('<tr>');
            html.push('<th>规格</th>');
            if(spec.show_type == 'image') html.push('<th>规格图片</th>');
            // html.push('<th>关联商品图片</th>');
            html.push('</tr>');
            html.push('</thead>');
            html.push('<tbody>');
            $.each(spec.option, function(k, v) {
                if(v.checked !== false) {
                    html.push('<tr data-id="' + spec_id + '_' + v.spec_value_id + '">');
                    html.push('<td>');
                    if(spec.show_type == 'image') {
                        html.push('<span class="spec-colorbox"><img src="' + list.find('img[key=spec_img_' + v.spec_value_id + ']').attr('src') + '"></span>');
                    }
                    html.push('<span class="spec-name">' + v.spec_value + '</span>');
                    html.push('</td>');
                    if(spec.show_type == 'image') html.push('<td><a class="select-image" data-toggle="modal" href="<{url action=topshop_ctl_shop_image@loadImageModal}>" data-target="#gallery_modal"><input type="hidden" name="images[' + spec_id + '_' + v.spec_value_id + ']" value="' + (v.spec_image || list.find('input[key=spec_image_' + v.spec_value_id + ']').val()) + '"><div class="img-put"><img src="' + (v.spec_image_url || list.find('img[key=spec_img_' + v.spec_value_id + ']').attr('src')) + '" /><i class="glyphicon glyphicon-picture"></i></div></a></td>');
                    //if(spec.show_type == 'image') html.push('<td><div class="choose-image"><input type="file" class="hide action-file-input" name="upload_file" data-size="2097152" data-remote="<{url action=toputil_ctl_image@uploadImages from=shop}>" accept="image/*" /><span class="image-box action-upload"><input type="hidden" name="images[' + spec_id + '_' + v.spec_value_id + ']" value="' + (v.spec_image || list.find('input[key=spec_image_' + v.spec_value_id + ']').val()) + '"><img src="' + (v.spec_image_url || list.find('img[key=spec_img_' + v.spec_value_id + ']').attr('src')) + '" /></span><b class="choose-handle action-upload" title="选择图片"><i class="icon-arrow-right-b"></i></b></div></td>');
                    html.push('</tr>');
                }
            })
            html.push('</tbody>');

            var table = $('<table>').addClass('table table-bordered').html(html.join('\n'));
            table.find('input[type=text]').prop('disabled', false);
            table.appendTo(this.specIMG.eq(i).empty());
            html = null;
        },
        props: ['sku_id', 'price','mkt_price','cost_price','supply_price','bank_price','store', 'bn', 'barcode', 'freez'],
        processProducts: function(arr, index, length, id, name, value, pvid) {
            var self = this, specid = {}, spec_name = [arr[index].name], specvalue = {}, specpvid={}, sname, spec_id = arr[index].id, uid;
            if(name) {
                spec_name = name.concat(spec_name);
            }
            if(value) specvalue = value;
            // if(id) specid = id;
            arr[index].input.each(function(i){
                specid[spec_id] = this.value;
                specpvid[spec_id] = this.name;
                specvalue[spec_id] = Spec[spec_id].option[this.value].spec_value;
                if(id) {
                    $.extend(specid, id);
                }
                if(pvid) {
                    $.extend(specpvid, pvid);
                }
                if(index < length - 1) {
                    self.processProducts(arr, index + 1, length, specid, spec_name, specvalue, specpvid);
                } else if(index == length - 1) {
                    var specid_values = [];
                    for(var key in specid) {
                        specid_values.push(specid[key]);
                    }
                    uid = getUniqueID(specid_values.join(';'));
                    sname = [];
                    $.each(spec_name, function(j) {
                        spec_id = arr[j].id;
                        if(Products[uid] && Products[uid].spec_desc) Products[uid].spec_desc.spec_value[spec_id] = specvalue[spec_id];
                        sname.push(this + ':' + specvalue[spec_id]);
                    });
                    sname = sname.join('，');
                    self.mapping(uid, sname, specvalue, specid, specpvid);
                }
            });
        },
        mapping: function(uid, specname, specvalue, specid, specpvid) {
            var arr = {};
            var self = this;
            $.each(this.props, function(i) {
                if(Products[uid] && (Products[uid][this] || Products[uid][this] === 0)) {
                    arr[this] = Products[uid][this];
                }
                else if(goods_info[this]) {
                    arr[this] = goods_info[this];
                    if(this == 'sku_id') {
                        arr[this] = 'new';
                    }
                    else if (this == 'bn') {
                        arr[this] = arr[this] + '-' + self.count;
                        self.count ++;
                    }
                }
                if(this == 'sku_id' && !arr[this]) {
                    arr[this] = 'new';
                }
            });
            if(!Products[uid]) {
                this.newProduct[uid] = $.extend(true, {}, arr);
                this.newProduct[uid].spec_desc = {};
                // this.newProduct[uid].spec_desc.spec_private_value_id = $.extend(true, {}, specpvid);
                this.newProduct[uid].spec_desc.spec_value = $.extend(true, {}, specvalue);
                this.newProduct[uid].spec_desc.spec_value_id = $.extend(true, {}, specid);
            }

            if(Products[uid] && activeProducts && activeProducts.length && activeProducts.indexOf(Products[uid].sku_id) > -1) {
                arr.unavailable = 'disabled';
                arr.title = '尚有未处理的订单，不能清除此货品。';
            }
            else {
                arr.title = '不生成此货品';
            }
            arr.idx = uid;
            if(specname) arr.spec = specname;
            this.products.push(arr);
        },
        createGoodsGrid: function() {
            this.specMap.data('instance', this);
            // if(!arr) return this.specMap.erase('html');
            var current = this.container.find('.current');
            current = current.size() ? parseInt(current.text()) : 1;
            this.pager = new Pager(this.specMap, this.products, {current: current, paging: 10});
            // $('#specification').Validator('addField', this.specMap.find('.price, .store'));
            getTotalStore();
        },
        saveNewProduct: function(uid) {
            var self = this;
            if($.type(uid) === 'array' && uid.length) {
                if(!$.isEmptyObject(this.newProduct)) {
                    $.each(this.newProduct, function(k) {
                        if(uid.indexOf(k) == -1) {
                            delete self.newProduct[k];
                        }
                    });
                }
            }
            else if(uid) {
                if(!Products[uid]) {
                    Products[uid] = $.extend(true, {}, this.newProduct[uid]);
                    delete this.newProduct[uid];
                }
                return;
            }
            if(!$.isEmptyObject(goods_info) && !$.isEmptyObject(this.newProduct)) {
                $.each(this.newProduct, function(k, v) {
                    if(v) Products[k] = $.extend(true, {}, v);
                });
                this.newProduct = {};
            }
        },
        storeData: function(el, uid, prop, sib) {
            this.saveNewProduct(uid);
            Products[uid][prop] = encodeURIComponent(el.value);

            if(!$.isEmptyObject(goods_info)) {
                var n = Products[uid][prop].match(/^.+\-(\d+)$/);
                if(n && n[1]) {
                    this.count = Math.max(this.count, Number(n[1]) + 1);
                }
            }

            for(var i = 0, j = this.products.length, k; i < j; i++) {
                k = this.products[i];
                if(k.idx === uid) {
                    k[prop] = el.value;
                    break;
                }
            }
        },
        validate: function(el) {
            return $(el).Validator();
        }
    });
    $(document).on('click', '.save-action', function () {
        //保存的时候将 单品或者多规格radio框的状态的disabled去掉，以便可以提交数据
        $('input[name="item[nospec]"]').attr("disabled", false);
        displaySpec($('input[name="item[nospec]"]:checked').val());
        // 保存sku信息
        Products && $('input[name="item[sku]"]').val(JSON.stringify(Products));
        Spec && $('input[name="item[spec]"]').val(JSON.stringify(Spec));
        // return false;
    });

    function getUniqueID(str) {
        return hex_md5(str).substr(0, 10);
    }

    /* $('.supplier-modal-dialog').on('click', '.brand-item', function() {
     $(this).addClass('active').siblings('.brand-item').removeClass('active');
     $('.brand-foot span').html($(this).html());
     }); */

    $('.brand-modal-dialog').on('click', '.brand-item', function() {
        $(this).addClass('active').siblings('.brand-item').removeClass('active');
        $('.brand-foot span').html($(this).html());
    });

    $('.brand-modal-dialog').on('click', '.btn-primary', function() {
        var chooseBrand = $('.brand-modal-dialog .brand-item.active');
        var brandId = chooseBrand.attr('data-brandid');
        $('.brand-choose-txt').html(chooseBrand.html());
        $('.brand-choose-txt').attr('data-id', brandId);
        $('#brandDialog').modal('hide');
        $('input[name="item[brand_id]"]').val(brandId);
    });

    //运费模板动态模态框
    $('#dlytmplDialog').on('show.bs.modal',function(){
        var tmpl_id = $('.dlytmpl-choose-txt').attr('data-id');
        $.get('<{url action=topshop_ctl_item@ajaxTmpl}>','',function (data) {
            console.log(data);
            var len=data.total_found;
            var content = '';
            for(j = 0; j < len; j++) {
                if(tmpl_id == data.data[j].template_id)
                {
                    content += '<a href="javascript:void(0);" class="list-group-item dlytmpl-item active" data-dlytmplid="'+data.data[j].template_id+'">'+data.data[j].name+'</a>';
                }else
                {
                    content += '<a href="javascript:void(0);" class="list-group-item dlytmpl-item" data-dlytmplid="'+data.data[j].template_id+'">'+data.data[j].name+'</a>';
                }
            }
            $('.list-group-dlytmpl').html(content);
        },'json');
    });

    $('.dlytmpl-modal-dialog').on('click', '.dlytmpl-item', function() {
        $(this).addClass('active').siblings('.dlytmpl-item').removeClass('active');
        $('.dlytmpl-foot span').html($(this).html());
    });

    $('.dlytmpl-modal-dialog').on('click', '.btn-primary', function() {
        var choosedlytmpl = $('.dlytmpl-modal-dialog .dlytmpl-item.active');
        var dlytmplId = choosedlytmpl.attr('data-dlytmplid');
        $('.dlytmpl-choose-txt').html(choosedlytmpl.html());
        $('.dlytmpl-choose-txt').attr('data-id', dlytmplId);
        $('#dlytmplDialog').modal('hide');
        $('input[name="item[dlytmpl_id]"]').val(dlytmplId);
    });

    //文本编辑器去重
    var editableSpan = $('.note-editable').find('span');
    editableSpan.each(function(){
        if($.trim($(this).text()) == "") {
            $(this).remove();
        }
    });

    //规格切换
    $('input[name="item[nospec]"]').on('change', function(){
        var itemSpec = $(this).val();
        displaySpec(itemSpec);
        var itemId = $('input[name="item[item_id]"]').val();
        if(itemId == "") {
            setTotalStore();
        }
    }).trigger('change');
    // displaySpec($('input[name="item[nospec]"]:checked').val());
    function displaySpec(itemspec) {
        if(itemspec == '1') { // 单品
            isnospec = true;
            $('.spec-props').hide();
            $('.goods-spec').hide();
            $('.spec-props').find('input').prop('disabled', true);
            $('.goods-spec').find('input').prop('disabled', true);
            // $('.goods-spec').find('input').removeAttr('required');
            $('input[name="item[store]"]').prop('readonly', false);
        } else if(itemspec == '0') { // 多规格
            isnospec = false;
            $('.spec-props').show();
            $('.goods-spec').show();
            $('.spec-props').find('input').prop('disabled', false);
            $('.goods-spec').find('input').prop('disabled', false);
            // $('.goods-spec').find('input').attr('required', 'required');
            $('input[name="item[store]"]').prop('readonly', true);
        }
    }

    $('.goods-spec').on('change', 'input[name$="[store]"]', function(){
        setTotalStore();
    });

    function setTotalStore() {
        $('input[name="item[store]"]').val(preTotalStore +  getPreTotalStore());
    }


    function getTotalStore() {
        var itemId = $('input[name="item[item_id]"]').val();
        if(itemId != '') { //编辑
            preTotalStore = Number($('input[name="item[store]"]').val()) - curStore;
        }
    }

    function getPreTotalStore() {
        var totalStore = 0;
        var specStores = $('.goods-spec').find('input[name$="[store]"]');
        specStores.each(function(){
            totalStore += Number($.trim($(this).val()) == '' ? 0 : $.trim($(this).val()));
        });
        return totalStore;
    }


    //商品信息楼层
    $('.goods-info-floor').on('click', 'li > a', function(){
        var parent = $(this).parent();
        var id = "#" + $(this).attr('data-id');
        parent.addClass('active').siblings('li').removeClass('active');
        $('html,body').animate({scrollTop: $(id).offset().top -50}, 500);
    });
    $('.goods-info-floor').on('click', '.glyphicon-remove', function(){
        $('.goods-info-floor').animate({right: -150}, 500);
        setTimeout(function(){
            $('.goods-info-floor').find('.floor-icon-box').show();
        }, 500);
    });
    $('.goods-info-floor').on('click', '.icon-show', function(){
        $('.goods-info-floor').animate({right: 10}, 500);
        $('.goods-info-floor').find('.floor-icon-box').hide();
    });
    //拖拽商品图片
    dragDom('.multiple-item');


    /*add_2017/9/26_by_wanghaichao_start*/
    $('.is_bank').click(function(){
        var is_bank=$(this).val();
        if(is_bank==1){
            $(".banks").show();
        }else{
            $(".banks").hide();
            $(".bank_price").hide();
        }
    });

    $('.only_bank').click(function(){
        var only_bank=$(this).val();
        if(only_bank==1){
            $(".bank_price").hide();
        }else{
            $(".bank_price").show();
        }
    });

    $('.reservation').daterangepicker({
        "timePicker": true,
        "opens": "right",
        "timePicker24Hour": true,
        "timePickerIncrement": 1,
        //"singleDatePicker": true,
        "locale": {
            "format": "YYYY/MM/DD HH:mm"
        }
    });

    $('.start_reservation').daterangepicker({
        "timePicker": true,
        "opens": "right",
        "timePicker24Hour": true,
        "timePickerIncrement": 1,
        "singleDatePicker": true,
        "locale": {
            "format": "YYYY/MM/DD HH:mm"
        }
    });
    $('.sell_open').click(function(){
        var open=$(this).val();
        if(open==1){
            $('.sell_time_start').show();
        }else{
            $('.sell_time_start').hide();
        }
    });
    $('.sell_end').click(function(){
        var open=$(this).val();
        if(open==1){
            $('.sell_time_end').show();
        }else{
            $('.sell_time_end').hide();
        }
    });

    //虚拟商品
    $('.is_virtual').on('click',function(){
        var virtual=$(this).val();
        if(virtual==1){
            $('.virtual').show();
            $('.confirm_type').show();
            $('.no-virtual').hide();
        }else{
            $('.virtual').hide();
            $('.confirm_type').hide();
            $('.no-virtual').show();
        }
    });
    //虚拟商品
    $('.is_limit').on('click',function(){
        var virtual=$(this).val();
        if(virtual==1){
            $('.limit_quantity').show();
        }else{
            $('.limit_quantity').hide();
        }
    });
    /* add_2018/01/19_by_gurundong_start */
    $.post('<{url action=topshop_ctl_item@search_supplier}>',{'default_action':true},function(res){
        if(res.error)
        {
            $('#messagebox').message(res.message, 'error');
        }else{
            $('.list-supplier').html(res.message);
        }
    });
    $('#supplierDialog').click(function() {
        var supplier_name = $('.supplier-choose-txt').text();
        $('.supplier-foot span').text(supplier_name);
    });
    $('#supplier-ser').click(function() {
        var supplier = $('#search_supplier').val();
        $.post('<{url action=topshop_ctl_item@search_supplier}>',{'supplier':supplier},function(res){
            if(res.error)
            {
                $('#messagebox').message(res.message, 'error');
            }else{
                $('.list-supplier').html(res.message);
            }
        });
    });
    $('#supplier-save').click(function(){
        var supplier_id = $('input[type="radio"][name="supplier-info"]:checked').val();
        var supplier_name = $('input[type="radio"][name="supplier-info"]:checked').parents('tr').find('.supplier_name').text();
        if(supplier_id){
            $('input[name="item[supplier_id]"]').val(supplier_id);
            $('.supplier-choose-txt').text(supplier_name);
        }
        $('#supplierDialog').modal('hide');
    });

    $('#agentShopDialog').on('show.bs.modal', function () {
        var supplier_id = $('input[name="item[supplier_id]"]').val();
        if(!supplier_id){
            $('#messagebox').message('请先选择供应商!', 'error');
            return false;
        }else{
            $.post('<{url action=topshop_ctl_item@agent_shop_list}>',{'supplier_id':supplier_id},function(res){
                if(res.error)
                {
                    $('#messagebox').message(res.message, 'error');
                }else{
                    $('.list-agent-shop').html(res.message);
                }
            });
        }
        $('#agent-shop-save').click(function(){
            var chk_value = [];
            var agent_shop_name = [];
            $('input[name="agent_shop_check"]:checked').each(function(){
                chk_value.push($(this).val());
                agent_shop_name.push($(this).parents('tr').find('.agent_shop_name').text());
            });
            // var json_str = JSON.stringify(chk_value);
            // var json_shop_str = JSON.stringify(agent_shop_name);
            if(chk_value)
            {
                $('input[name="item[agent_shop_id]"]').val(chk_value);
                $('.agent-shop-choose-txt').text(agent_shop_name);
            }
            $('#agentShopDialog').modal('hide');
        });
    })
</script>
